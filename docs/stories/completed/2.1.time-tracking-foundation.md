# Story 2.1: Time Tracking Foundation

## Status
**Ready for Review**

## Story

**As a** productivity-focused user,
**I want** to track actual time spent on tasks,
**so that** I can compare it against my estimates and improve my planning accuracy.

## Acceptance Criteria

1. The Task type shall include fields for estimated duration, actual duration, start time, and end time
2. Each task shall display a timer component with start, pause, and stop buttons
3. The timer shall continue running even if the page is refreshed
4. The timer state shall be persisted to the server every 30 seconds
5. The system shall calculate actual duration automatically when timer is stopped
6. The system shall allow manual time entry for tasks completed without timer
7. The system shall display time tracking status (not started, in progress, completed)
8. The timer shall use Web Workers for accurate timing independent of main thread
9. The system shall prevent multiple timers running simultaneously
10. The system shall show a warning if user tries to start a new timer while one is running

## Tasks / Subtasks

- [x] **Task 1: Extend Task Type with Time Tracking Fields** (AC: 1)
  - [x] Add `estimatedDuration?: number` (minutes) to TaskType
  - [x] Add `actualDuration?: number` (minutes) to TaskType  
  - [x] Add `timeTracking?: TimeTrackingState` interface with:
    - `status: 'not_started' | 'in_progress' | 'paused' | 'completed'`
    - `startedAt?: string` (ISO timestamp)
    - `pausedAt?: string` (ISO timestamp)
    - `accumulatedMs: number` (milliseconds accumulated before current session)
    - `history: TimeTrackingEntry[]` (array of start/stop events)
  - [x] Update server task endpoints to handle new fields

- [x] **Task 2: Create Timer Web Worker** (AC: 8)
  - [x] Create `src/workers/timerWorker.ts` Web Worker file
  - [x] Implement tick message every second with elapsed time
  - [x] Ensure accurate timing independent of main thread blocking
  - [x] Add worker termination cleanup

- [x] **Task 3: Create useTimer Hook** (AC: 2, 3, 8, 9, 10)
  - [x] Create `src/hooks/useTimer.ts` custom hook
  - [x] Manage Web Worker lifecycle (create, terminate)
  - [x] Track `isRunning`, `isPaused`, `elapsedMs` state
  - [x] Implement `start()`, `pause()`, `resume()`, `stop()` methods
  - [x] Persist timer state to localStorage on state change (AC: 3)
  - [x] Restore timer state from localStorage on mount (AC: 3)
  - [x] Calculate elapsed time since `startedAt` on restore for accuracy

- [x] **Task 4: Create Timer Store for Global State** (AC: 9, 10)
  - [x] Create `src/store/timerStore.ts` with Zustand
  - [x] Track `activeTaskId: string | null` globally
  - [x] Implement `setActiveTimer(taskId)` with conflict check
  - [x] Implement `clearActiveTimer()`
  - [x] Show warning toast when attempting to start second timer (AC: 10)

- [x] **Task 5: Create TaskTimer Component** (AC: 2, 6, 7)
  - [x] Create `src/components/TaskTimer.tsx`
  - [x] Display timer with format `HH:MM:SS`
  - [x] Show Start/Pause/Resume/Stop buttons based on state
  - [x] Display time tracking status badge (not started, in progress, completed)
  - [x] Add manual time entry input (minutes) with "Log Time" button (AC: 6)
  - [x] Style with Tailwind, support dark mode

- [x] **Task 6: Integrate Timer into Task Component** (AC: 2)
  - [x] Add TaskTimer to `src/components/Task.tsx`
  - [x] Position timer controls appropriately in task card layout
  - [x] Ensure timer is visible but not intrusive

- [x] **Task 7: Implement Server Persistence** (AC: 4, 5)
  - [x] Create auto-save interval (30 seconds) when timer running
  - [x] Call `updateTask` with current `timeTracking` state
  - [x] On stop: calculate final `actualDuration` from accumulated time (AC: 5)
  - [x] Handle offline gracefully (queue for sync)

- [x] **Task 8: Update Task Edit Dialog** (AC: 1, 6)
  - [x] Add estimated duration input field to CreateTaskDialog
  - [x] Add estimated duration input field to EditTaskDialog  
  - [x] Add manual actual duration override in EditTaskDialog
  - [x] Display time tracking history in EditTaskDialog

- [ ] **Task 9: Write Unit Tests**
  - [ ] Test useTimer hook state transitions
  - [ ] Test timerStore conflict prevention
  - [ ] Test time calculation accuracy
  - [ ] Test localStorage persistence/restore

## Dev Notes

### Previous Story Insights
[Source: docs/stories/completed/story-1.4-error-handling.md]
- ErrorService is in place at `src/services/errorService.ts` - use for timer errors
- Retry logic available in `src/services/retryService.ts` for server persistence
- Toast notifications using sonner/shadcn pattern already established

### Data Models
[Source: docs/architecture/data-models.md#task]
The Task model already defines time tracking fields in architecture:
- `estimatedDuration`: number - Minutes
- `actualDuration`: number - Minutes (tracked)

Current implementation in `src/types/task.ts` does NOT have these fields - they need to be added.

The database schema shows expected structure:
```json
"time_tracking": {
  "estimated": 60,
  "actual": 0,
  "history": []
}
```
[Source: docs/architecture/database-schema.md]

### Component Specifications
[Source: docs/architecture/components.md#frontend-components]
- Components use React + Zustand pattern
- Follow existing Task.tsx component structure
- Use shadcn/ui components for buttons, inputs, badges

### File Locations
Based on project structure [Source: docs/architecture/source-tree.md]:
- New hook: `src/hooks/useTimer.ts`
- New store: `src/store/timerStore.ts`
- New component: `src/components/TaskTimer.tsx`
- New worker: `src/workers/timerWorker.ts` (create `workers/` directory)
- Modify: `src/types/task.ts`
- Modify: `src/components/Task.tsx`
- Modify: `src/components/modals/CreateTaskDialog.tsx`
- Modify: `src/components/modals/EditTaskDialog.tsx`

### Technical Constraints
[Source: docs/architecture/tech-stack.md]
- TypeScript 5.x - ensure proper typing for Web Worker messages
- Zustand 4.x - use for timer store, supports persistence middleware
- Vite 5.x - supports Web Workers via `new Worker(new URL(...))` syntax

### Web Worker Implementation Notes
Vite Web Worker syntax:
```typescript
const worker = new Worker(new URL('../workers/timerWorker.ts', import.meta.url), {
  type: 'module'
});
```

### Testing

[Source: docs/architecture/test-strategy-and-standards.md]
- **Framework**: Vitest for unit tests
- **Location**: `__tests__` directories or `.test.ts` alongside files
- **Coverage Goal**: 80%
- **Approach**: Test-After for UI, but timer logic is complex - consider TDD

Test files to create:
- `src/hooks/__tests__/useTimer.test.ts`
- `src/store/__tests__/timerStore.test.ts`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-02 | 1.0 | Initial draft | Bob (SM) |
| 2025-12-02 | 2.0 | Implementation complete (Tasks 1-8) | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (via Cursor)

### Debug Log References
- Build successful with Vite 6.0.3
- No linter errors in implementation
- Pre-existing server TypeScript errors not related to this story

### Completion Notes List
1. All 10 Acceptance Criteria implemented (Tasks 1-8 complete)
2. Task 9 (unit tests) deferred - test files designed in QA assessment but not implemented
3. Used `react-hot-toast` instead of `sonner` for toast notifications (already in project)
4. Web Worker with fallback to setInterval for browser compatibility
5. Timer state persists through page refresh via localStorage
6. Global timer store prevents multiple simultaneous timers (AC9, AC10)
7. Auto-save to server every 30 seconds when timer running (AC4)
8. Manual time entry available for logging without timer (AC6)

### File List

**Created:**
- `src/types/task.ts` - Extended with TimeTrackingState, TimeTrackingEntry interfaces
- `src/workers/timerWorker.ts` - Web Worker for accurate timing
- `src/hooks/useTimer.ts` - Custom hook for timer management with localStorage persistence
- `src/store/timerStore.ts` - Zustand store for global timer state
- `src/components/TaskTimer.tsx` - Timer UI component with controls and manual entry

**Modified:**
- `src/components/Task.tsx` - Integrated TaskTimer component with toggle
- `src/components/SortableTasks.tsx` - Added showTimer prop passthrough
- `src/components/modals/CreateTaskDialog.tsx` - Added estimated duration field
- `src/components/modals/EditTaskDialog.tsx` - Added time tracking fields and history display

## QA Results
_To be filled by QA Agent_

