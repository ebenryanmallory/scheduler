# Story 3.3: Enhanced Git Sync

## Status
**Ready for Dev**

## Story

**As a** user working across multiple devices,
**I want** automatic Git sync with conflict resolution,
**so that** my tasks stay synchronized without manual intervention.

## Acceptance Criteria

1. The system shall automatically commit task changes to Git repository
2. The system shall debounce commits to batch changes (wait 30 seconds after last change)
3. The system shall automatically push commits to remote repository
4. The system shall display sync status indicator (synced, syncing, error)
5. The system shall show last sync timestamp in the UI
6. The system shall provide a manual sync button for immediate syncing
7. The system shall implement conflict resolution UI when merge conflicts occur
8. The system shall show diff view for conflicting changes
9. The system shall allow users to choose "keep local", "keep remote", or "merge manually"
10. The system shall maintain a sync history/log accessible to users
11. The system shall handle Git authentication securely on the server
12. The system shall retry failed push operations with exponential backoff

## Tasks / Subtasks

- [ ] **Task 1: Design Git Sync Architecture** (AC: 1, 3)
  - [ ] Decide on sync trigger points (after task CRUD, on timer)
  - [ ] Design commit message format
  - [ ] Plan server-side Git operations (commit, push, pull)
  - [ ] Document sync flow diagram

- [ ] **Task 2: Implement Auto-Commit with Debounce** (AC: 1, 2)
  - [ ] Create `GitSyncService` on server
  - [ ] Implement debounce mechanism (30s after last change)
  - [ ] Create meaningful commit messages:
    - "Add task: {title}"
    - "Update task: {title}"
    - "Delete task: {title}"
    - "Batch update: {n} tasks modified"
  - [ ] Handle commit errors gracefully
  - [ ] Avoid committing during active user edits

- [ ] **Task 3: Implement Auto-Push** (AC: 3, 12)
  - [ ] Push after each commit (or batch commits)
  - [ ] Implement retry logic with exponential backoff
  - [ ] Maximum retry attempts: 5
  - [ ] Handle push rejection (needs pull first)
  - [ ] Queue push operations if offline (integrate with Story 3.2)

- [ ] **Task 4: Create Sync Status UI** (AC: 4, 5, 6)
  - [ ] Create `SyncStatusIndicator` component
  - [ ] Show status: "Synced ✓", "Syncing...", "Error ⚠"
  - [ ] Display last sync timestamp (relative: "2 min ago")
  - [ ] Add manual "Sync Now" button
  - [ ] Show pending changes count
  - [ ] Position in header or footer

- [ ] **Task 5: Implement Pull and Merge** (AC: 7, 8, 9)
  - [ ] Implement auto-pull before push
  - [ ] Detect merge conflicts (Git returns conflict markers)
  - [ ] Parse conflict markers from JSON files
  - [ ] Create `ConflictResolutionDialog` component:
    - Display local vs remote changes
    - Show diff highlighting
    - Three resolution options
  - [ ] Implement "Keep Local" (force push)
  - [ ] Implement "Keep Remote" (discard local)
  - [ ] Implement "Merge Manually" (edit combined)
  - [ ] Mark conflicts as resolved

- [ ] **Task 6: Create Sync History Log** (AC: 10)
  - [ ] Create `SyncLog` data structure
  - [ ] Log each sync operation with:
    - Timestamp
    - Operation type (commit, push, pull)
    - Status (success, error)
    - Details (commit hash, error message)
  - [ ] Store last N log entries (configurable, default 50)
  - [ ] Create `SyncHistoryModal` component
  - [ ] Allow viewing sync history from UI

- [ ] **Task 7: Handle Authentication** (AC: 11)
  - [ ] Use existing server-side Git credentials
  - [ ] Support SSH key authentication (server config)
  - [ ] Support HTTPS with token (server config)
  - [ ] Never expose credentials to client
  - [ ] Handle auth failures with clear error messages

- [ ] **Task 8: Create API Endpoints** (All ACs)
  - [ ] `POST /api/sync/commit` - Trigger immediate commit
  - [ ] `POST /api/sync/push` - Trigger immediate push
  - [ ] `POST /api/sync/pull` - Pull from remote
  - [ ] `GET /api/sync/status` - Get current sync status
  - [ ] `GET /api/sync/history` - Get sync history
  - [ ] `POST /api/sync/resolve` - Resolve conflict

- [ ] **Task 9: Implement WebSocket Updates** (AC: 4, 5)
  - [ ] Create WebSocket connection for real-time sync status
  - [ ] Broadcast sync status changes to all clients
  - [ ] Update UI automatically when sync completes
  - [ ] Handle connection drops gracefully

- [ ] **Task 10: Write Unit Tests**
  - [ ] Test debounce logic
  - [ ] Test retry logic
  - [ ] Test conflict detection
  - [ ] Test sync status state machine

## Dev Notes

### Sync Flow
```
User Edit → Debounce (30s) → Commit → Push
                                  ↓
                            Success? → Update UI
                                  ↓
                              Error?
                                  ↓
                            Conflict? → Show Resolution UI
                                  ↓
                            Auth Error? → Show Error
                                  ↓
                            Retry → Exponential Backoff
```

### Commit Message Format
```
feat(tasks): Update "Morning meeting"

Modified: scheduledTime 09:00 → 10:00
---
Automated commit by Scheduler App
```

### Conflict Detection
Git returns conflict markers in files:
```json
<<<<<<< HEAD
{"title": "Local version"}
=======
{"title": "Remote version"}
>>>>>>> origin/main
```

### Server-Side Git Operations
```typescript
// server/services/gitSyncService.ts
import simpleGit from 'simple-git';

const git = simpleGit(repoPath);

async function commitAndPush(message: string) {
  await git.add('.');
  await git.commit(message);
  await git.push('origin', 'main');
}
```

### Debounce Implementation
```typescript
const DEBOUNCE_MS = 30000;
let commitTimeout: NodeJS.Timeout | null = null;

function scheduleCommit() {
  if (commitTimeout) clearTimeout(commitTimeout);
  commitTimeout = setTimeout(() => {
    performCommit();
  }, DEBOUNCE_MS);
}
```

### Dependencies to Add
- `simple-git` - Git operations from Node.js (server)
- May need WebSocket library if not already present

### File Locations
- Server services:
  - `server/services/gitSyncService.ts`
- Server routes:
  - `server/routes/sync.ts`
- Client services:
  - `src/services/syncService.ts`
- Client components:
  - `src/components/SyncStatusIndicator.tsx`
  - `src/components/SyncHistoryModal.tsx`
  - `src/components/ConflictResolutionDialog.tsx`
- Client hooks:
  - `src/hooks/useGitSync.ts`

### Edge Cases
- Simultaneous edits from multiple devices
- Large commits with many changes
- Network failure during push
- Force push overwriting remote changes
- Git repo not initialized
- Merge conflicts in binary files (if any)

## Testing

### Key Test Scenarios
1. Edit task, wait 30s, verify commit and push
2. Edit multiple tasks quickly, verify single batched commit
3. Simulate conflict, test all resolution options
4. Test retry after push failure
5. Test sync status updates in real-time
6. Test manual sync button

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-03 | 1.0 | Initial draft | Bob (SM) |

## Dev Agent Record
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_

