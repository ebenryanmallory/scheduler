# Story 3.3: Enhanced Git Sync

## Status
**QA PASS (92)** âœ…

## Story

**As a** user working across multiple devices,
**I want** automatic Git sync with conflict resolution,
**so that** my tasks stay synchronized without manual intervention.

## Acceptance Criteria

1. The system shall automatically commit task changes to Git repository
2. The system shall debounce commits to batch changes (wait 30 seconds after last change)
3. The system shall automatically push commits to remote repository
4. The system shall display sync status indicator (synced, syncing, error)
5. The system shall show last sync timestamp in the UI
6. The system shall provide a manual sync button for immediate syncing
7. The system shall implement conflict resolution UI when merge conflicts occur
8. The system shall show diff view for conflicting changes
9. The system shall allow users to choose "keep local", "keep remote", or "merge manually"
10. The system shall maintain a sync history/log accessible to users
11. The system shall handle Git authentication securely on the server
12. The system shall retry failed push operations with exponential backoff

## Tasks / Subtasks

- [x] **Task 1: Design Git Sync Architecture** (AC: 1, 3)
  - [x] Decide on sync trigger points (after task CRUD, on timer)
  - [x] Design commit message format
  - [x] Plan server-side Git operations (commit, push, pull)
  - [x] Document sync flow diagram

- [x] **Task 2: Implement Auto-Commit with Debounce** (AC: 1, 2)
  - [x] Create `GitSyncService` on server
  - [x] Implement debounce mechanism (30s after last change)
  - [x] Create meaningful commit messages:
    - "Add task: {title}"
    - "Update task: {title}"
    - "Delete task: {title}"
    - "Batch update: {n} tasks modified"
  - [x] Handle commit errors gracefully
  - [x] Avoid committing during active user edits

- [x] **Task 3: Implement Auto-Push** (AC: 3, 12)
  - [x] Push after each commit (or batch commits)
  - [x] Implement retry logic with exponential backoff
  - [x] Maximum retry attempts: 5
  - [x] Handle push rejection (needs pull first)
  - [x] Queue push operations if offline (integrate with Story 3.2)

- [x] **Task 4: Create Sync Status UI** (AC: 4, 5, 6)
  - [x] Create `SyncStatusIndicator` component
  - [x] Show status: "Synced âœ“", "Syncing...", "Error âš "
  - [x] Display last sync timestamp (relative: "2 min ago")
  - [x] Add manual "Sync Now" button
  - [x] Show pending changes count
  - [x] Position in header or footer

- [x] **Task 5: Implement Pull and Merge** (AC: 7, 8, 9)
  - [x] Implement auto-pull before push
  - [x] Detect merge conflicts (Git returns conflict markers)
  - [x] Parse conflict markers from JSON files
  - [x] Create `GitConflictDialog` component:
    - Display local vs remote changes
    - Show diff highlighting
    - Three resolution options
  - [x] Implement "Keep Local" (force push)
  - [x] Implement "Keep Remote" (discard local)
  - [x] Implement "Merge Manually" (edit combined)
  - [x] Mark conflicts as resolved

- [x] **Task 6: Create Sync History Log** (AC: 10)
  - [x] Create `SyncLog` data structure
  - [x] Log each sync operation with:
    - Timestamp
    - Operation type (commit, push, pull)
    - Status (success, error)
    - Details (commit hash, error message)
  - [x] Store last N log entries (configurable, default 50)
  - [x] Create `SyncHistoryModal` component
  - [x] Allow viewing sync history from UI

- [x] **Task 7: Handle Authentication** (AC: 11)
  - [x] Use existing server-side Git credentials
  - [x] Support SSH key authentication (server config)
  - [x] Support HTTPS with token (server config)
  - [x] Never expose credentials to client
  - [x] Handle auth failures with clear error messages

- [x] **Task 8: Create API Endpoints** (All ACs)
  - [x] `POST /api/sync/commit` - Trigger immediate commit
  - [x] `POST /api/sync/now` - Trigger immediate sync
  - [x] `GET /api/sync/status` - Get current sync status
  - [x] `GET /api/sync/history` - Get sync history
  - [x] `POST /api/sync/resolve` - Resolve conflict
  - [x] `GET /api/sync/conflicts` - Get conflict details
  - [x] `POST /api/sync/cancel` - Cancel pending sync

- [x] **Task 9: Implement Real-time Updates** (AC: 4, 5)
  - [x] Create SSE endpoint for real-time sync status
  - [x] Broadcast sync status changes to all clients
  - [x] Update UI automatically when sync completes
  - [x] Handle connection drops gracefully

- [x] **Task 10: Write Unit Tests** âœ…
  - [x] Test debounce logic
  - [x] Test retry logic
  - [x] Test conflict detection
  - [x] Test sync status state machine

## Dev Notes

### Sync Flow
```
User Edit â†’ Debounce (30s) â†’ Commit â†’ Push
                                  â†“
                            Success? â†’ Update UI
                                  â†“
                              Error?
                                  â†“
                            Conflict? â†’ Show Resolution UI
                                  â†“
                            Auth Error? â†’ Show Error
                                  â†“
                            Retry â†’ Exponential Backoff
```

### Commit Message Format
```
feat(tasks): Update "Morning meeting"

Modified: scheduledTime 09:00 â†’ 10:00
---
Automated commit by Scheduler App
```

### Conflict Detection
Git returns conflict markers in files:
```json
<<<<<<< HEAD
{"title": "Local version"}
=======
{"title": "Remote version"}
>>>>>>> origin/main
```

### Server-Side Git Operations
```typescript
// server/services/gitSyncService.ts
import simpleGit from 'simple-git';

const git = simpleGit(repoPath);

async function commitAndPush(message: string) {
  await git.add('.');
  await git.commit(message);
  await git.push('origin', 'main');
}
```

### Debounce Implementation
```typescript
const DEBOUNCE_MS = 30000;
let commitTimeout: NodeJS.Timeout | null = null;

function scheduleCommit() {
  if (commitTimeout) clearTimeout(commitTimeout);
  commitTimeout = setTimeout(() => {
    performCommit();
  }, DEBOUNCE_MS);
}
```

### Dependencies to Add
- `simple-git` - Git operations from Node.js (server)
- May need WebSocket library if not already present

### File Locations
- Server services:
  - `server/services/gitSyncService.ts`
- Server routes:
  - `server/routes/sync.ts`
- Client services:
  - `src/services/syncService.ts`
- Client components:
  - `src/components/SyncStatusIndicator.tsx`
  - `src/components/SyncHistoryModal.tsx`
  - `src/components/ConflictResolutionDialog.tsx`
- Client hooks:
  - `src/hooks/useGitSync.ts`

### Edge Cases
- Simultaneous edits from multiple devices
- Large commits with many changes
- Network failure during push
- Force push overwriting remote changes
- Git repo not initialized
- Merge conflicts in binary files (if any)

## Testing

### Key Test Scenarios
1. Edit task, wait 30s, verify commit and push
2. Edit multiple tasks quickly, verify single batched commit
3. Simulate conflict, test all resolution options
4. Test retry after push failure
5. Test sync status updates in real-time
6. Test manual sync button

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-03 | 1.0 | Initial draft | Bob (SM) |

## Dev Agent Record

### Implementation Summary
**Date:** 2025-12-04
**Status:** Complete

### Files Created
- `server/services/gitSyncService.ts` - Core Git sync service with debounce, retry, and conflict handling
- `server/routes/sync.ts` - REST API endpoints + SSE for real-time updates
- `src/hooks/useGitSync.ts` - React hook for client-side sync state management
- `src/components/SyncStatusIndicator.tsx` - Header badge with popover details
- `src/components/SyncHistoryModal.tsx` - Modal showing sync history log
- `src/components/GitConflictDialog.tsx` - UI for resolving Git merge conflicts

### Files Modified
- `server/index.ts` - Added sync routes, gitSyncService initialization, commit scheduling on CRUD
- `src/App.tsx` - Added SyncStatusBadge to header
- `package.json` - Added `simple-git` dependency

### Architecture Decisions
1. **SSE over WebSocket**: Used Server-Sent Events for real-time sync status updates as it's simpler for unidirectional serverâ†’client communication
2. **30s Debounce**: Commits are batched with a 30-second debounce to avoid excessive Git commits during rapid edits
3. **Exponential Backoff**: Push retry uses exponential backoff (1s, 2s, 4s, 8s, 16s) with max 5 retries
4. **Auto-pull Before Push**: System automatically pulls and attempts merge before pushing to handle concurrent edits

### API Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/sync/events` | SSE stream for real-time status |
| GET | `/api/sync/status` | Current sync state |
| GET | `/api/sync/history` | Sync log (last 50 entries) |
| POST | `/api/sync/now` | Trigger immediate sync |
| POST | `/api/sync/commit` | Schedule a commit |
| GET | `/api/sync/conflicts` | Get conflict details |
| POST | `/api/sync/resolve` | Resolve a conflict |
| POST | `/api/sync/cancel` | Cancel pending sync |

### Acceptance Criteria Coverage
- âœ… AC1: Auto-commit task changes to Git
- âœ… AC2: 30-second debounce for batching
- âœ… AC3: Auto-push to remote
- âœ… AC4: Sync status indicator (idle/syncing/synced/error/conflict)
- âœ… AC5: Last sync timestamp with relative formatting
- âœ… AC6: Manual "Sync Now" button
- âœ… AC7: Conflict resolution UI
- âœ… AC8: Diff view for conflicting changes
- âœ… AC9: Keep local/remote/merge options
- âœ… AC10: Sync history log accessible via modal
- âœ… AC11: Server-side Git authentication (SSH/HTTPS)
- âœ… AC12: Retry with exponential backoff (5 attempts max)

### Notes
- Unit tests deferred to QA phase
- Git remote must be pre-configured on server for push/pull to work
- If no remote configured, commit-only mode is active (no push errors)

## QA Results

### Quality Gate
**Date:** 2025-12-04
**Reviewer:** Quinn (Test Architect)
**Status:** âœ… PASS (Score: 85)

#### Acceptance Criteria Coverage: 12/12 (100%)
All acceptance criteria have implementation coverage.

#### Issues Found

| ID | Severity | Description | Status |
|----|----------|-------------|--------|
| ISSUE-001 | ðŸ”´ HIGH | Bug in `useGitSync` - incorrect `useOnlineStatus()` usage returns object instead of boolean | âœ… FIXED |
| ISSUE-002 | ðŸŸ¡ MEDIUM | Missing Git sync calls for Idea CRUD operations | âœ… FIXED |
| ISSUE-003 | ðŸŸ¡ MEDIUM | Hardcoded 'main' branch name should be configurable | âœ… FIXED |
| ISSUE-004 | ðŸŸ¡ LOW-MED | Potential memory accumulation in SSE client tracking | OPEN |
| ISSUE-005 | ðŸŸ¢ LOW | Two conflict resolution dialogs need documentation | OPEN |
| ISSUE-006 | ðŸŸ¢ LOW | Unit tests deferred (acceptable for MVP) | âœ… IMPLEMENTED |

#### Blocking Issue
~~**ISSUE-001 must be fixed before quality gate can pass.**~~ âœ… **FIXED**

The bug caused `isOnline` to always be truthy (it was assigned an object, not a boolean), breaking offline detection in the Git sync feature.

**Fix applied in `src/hooks/useGitSync.ts` line 51:**
```typescript
// Changed from:
const isOnline = useOnlineStatus()

// To:
const { isOnline } = useOnlineStatus()
```

#### Positive Observations
- Clean architecture with proper separation of concerns
- SSE implementation appropriate for real-time updates
- Excellent conflict resolution UX with diff view
- Proper exponential backoff retry logic
- Mobile responsive design

#### Full Assessment
- Code Review: `docs/qa/assessments/3.3-code-review-20251204.md`
- Quality Gate: `docs/qa/gates/3.3-enhanced-git-sync.yml`

