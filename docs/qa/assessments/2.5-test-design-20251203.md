# Test Design: Story 2.5 - Quick Stats Widget

**Date:** 2025-12-03  
**Designer:** Quinn (Test Architect)  
**Story:** 2.5 - Quick Stats Widget

## Test Strategy Overview

- **Total test scenarios:** 32
- **Unit tests:** 18 (56%)
- **Integration tests:** 10 (31%)
- **E2E tests:** 4 (13%)
- **Priority distribution:** P0: 8, P1: 14, P2: 8, P3: 2

## Test Scenarios by Acceptance Criteria

### AC1: Quick stats widget on main dashboard

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.5-INT-001 | Integration | P1 | Widget renders in App.tsx layout | Component integration |
| 2.5-E2E-001 | E2E | P1 | Widget visible on page load | User-facing critical path |
| 2.5-INT-002 | Integration | P2 | Widget coexists with TimeAnalyticsWidget | Layout integration |

### AC2: Tasks completed vs total for today

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.5-UNIT-001 | Unit | P0 | `calculateDailyProgress` returns correct completed count | Core calculation |
| 2.5-UNIT-002 | Unit | P0 | `calculateDailyProgress` returns correct total count | Core calculation |
| 2.5-UNIT-003 | Unit | P1 | `calculateDailyProgress` filters only today's tasks | Date filtering |
| 2.5-UNIT-004 | Unit | P1 | `calculateDailyProgress` handles empty task array | Edge case |
| 2.5-UNIT-005 | Unit | P2 | Percentage calculated as (completed/total)*100 | Display formatting |

### AC3: Weekly streak counter

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.5-UNIT-006 | Unit | P0 | `calculateStreak` counts consecutive days correctly | Core business logic |
| 2.5-UNIT-007 | Unit | P0 | `calculateStreak` resets after gap day | Critical edge case |
| 2.5-UNIT-008 | Unit | P0 | `calculateStreak` handles midnight boundary | High risk (DATA-001) |
| 2.5-UNIT-009 | Unit | P1 | `calculateStreak` tracks longest streak | Feature requirement |
| 2.5-UNIT-010 | Unit | P1 | `calculateStreak` works with no tasks | Edge case |
| 2.5-UNIT-011 | Unit | P2 | Streak persists to localStorage | Persistence |
| 2.5-INT-003 | Integration | P1 | Streak reconstructs from tasks if localStorage empty | Risk mitigation |

### AC4: Focus time vs break time

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.5-UNIT-012 | Unit | P1 | `calculateFocusBreakdown` sums tracked time correctly | Core calculation |
| 2.5-UNIT-013 | Unit | P1 | Focus breakdown handles tasks without time tracking | Edge case |
| 2.5-UNIT-014 | Unit | P2 | Ratio calculated as focus/(focus+break) | Display math |

### AC5: Productivity score

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.5-UNIT-015 | Unit | P0 | `calculateProductivityScore` follows weight formula | Core business logic |
| 2.5-UNIT-016 | Unit | P1 | Score capped at 100, floored at 0 | Boundary validation |
| 2.5-UNIT-017 | Unit | P1 | Score handles zero tasks (returns 0, not NaN) | Edge case |
| 2.5-INT-004 | Integration | P1 | Score integrates accuracy from TimeAnalytics | Cross-component |

### AC6: Widget is collapsible

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.5-INT-005 | Integration | P1 | Toggle button expands/collapses widget | UI interaction |
| 2.5-INT-006 | Integration | P2 | Collapse state persists to localStorage | State persistence |
| 2.5-UNIT-018 | Unit | P2 | Widget restores collapse state on mount | Initialization |

### AC7: Real-time updates

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.5-INT-007 | Integration | P0 | Widget updates when task completed | Critical real-time sync |
| 2.5-E2E-002 | E2E | P1 | Progress ring animates when task checked | User-visible behavior |
| 2.5-INT-008 | Integration | P2 | Updates debounced to prevent excessive renders | Performance |

### AC8: Charts for visual appeal

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.5-INT-009 | Integration | P1 | Progress ring renders with correct percentage | Visual accuracy |
| 2.5-E2E-003 | E2E | P2 | Productivity gauge shows color gradient | Visual verification |

### AC9: Click-through to detailed analytics

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.5-INT-010 | Integration | P2 | Clicking progress opens task list | Navigation |
| 2.5-E2E-004 | E2E | P3 | Click-through navigation works for all cards | End-to-end flow |

### AC10: Milestone celebrations

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.5-UNIT-019* | Unit | P1 | Milestone triggers at 7-day streak | Threshold validation |
| 2.5-UNIT-020* | Unit | P1 | Milestone triggers at 30-day streak | Threshold validation |
| 2.5-INT-011* | Integration | P1 | Milestone toast shows with correct message | UI integration |
| 2.5-INT-012* | Integration | P1 | Seen milestones not re-triggered | Deduplication (UX-001) |

*Note: Tests 019-020 numbered separately for milestone logic

---

## Risk Coverage Mapping

| Risk ID | Test IDs | Coverage |
|---------|----------|----------|
| DATA-001 (High) | 2.5-UNIT-006, 007, 008, INT-003 | Direct mitigation tests |
| DATA-002 | 2.5-UNIT-012, 013, 014 | Focus time validation |
| PERF-001 | 2.5-INT-008 | Debounce validation |
| UX-001 | 2.5-INT-012 | Deduplication test |
| TECH-001 | 2.5-INT-003 | localStorage fallback |

---

## Recommended Execution Order

### Phase 1: P0 Critical (Fail Fast)
1. 2.5-UNIT-001: Daily progress completed count
2. 2.5-UNIT-002: Daily progress total count
3. 2.5-UNIT-006: Streak consecutive days
4. 2.5-UNIT-007: Streak gap detection
5. 2.5-UNIT-008: Streak midnight boundary
6. 2.5-UNIT-015: Productivity score formula
7. 2.5-INT-007: Real-time task completion updates
8. 2.5-PERF-001: Dual widget render performance

### Phase 2: P1 High Priority
1. All remaining UNIT tests (edge cases, formatting)
2. 2.5-INT-001, 003, 004, 005: Component integrations
3. 2.5-INT-009, 011, 012: Visual and milestone tests
4. 2.5-E2E-001, 002: Critical user journeys

### Phase 3: P2 Medium Priority
1. 2.5-INT-002, 006, 008, 010: Secondary integrations
2. 2.5-UNIT-005, 011, 014, 018: Format/persist logic
3. 2.5-E2E-003: Visual verification

### Phase 4: P3 (If Time Permits)
1. 2.5-E2E-004: Full navigation flow

---

## Test Data Requirements

### Mock Task Data

```typescript
const mockTasks: TaskType[] = [
  // Today - completed task with time tracking
  {
    id: '1',
    title: 'Task A',
    date: new Date().toISOString().split('T')[0], // today
    completed: true,
    estimatedDuration: 60,
    actualDuration: 45,
    timeTracking: { status: 'completed', accumulatedMs: 2700000, history: [] }
  },
  // Today - incomplete task
  {
    id: '2',
    title: 'Task B',
    date: new Date().toISOString().split('T')[0],
    completed: false,
    estimatedDuration: 30
  },
  // Today - completed, no time tracking
  {
    id: '3',
    title: 'Task C',
    date: new Date().toISOString().split('T')[0],
    completed: true
  },
  // Yesterday - completed (for streak)
  {
    id: '4',
    title: 'Task D',
    date: new Date(Date.now() - 86400000).toISOString().split('T')[0],
    completed: true
  },
  // 2 days ago - completed (for streak)
  {
    id: '5',
    title: 'Task E',
    date: new Date(Date.now() - 172800000).toISOString().split('T')[0],
    completed: true
  },
  // 4 days ago - completed (gap in streak)
  {
    id: '6',
    title: 'Task F',
    date: new Date(Date.now() - 345600000).toISOString().split('T')[0],
    completed: true
  }
];
```

### Expected Calculations (from mockTasks)

| Metric | Expected Value | Notes |
|--------|----------------|-------|
| Daily Progress | 2 of 3 (67%) | Tasks 1, 2, 3 are today; 1 and 3 completed |
| Current Streak | 3 days | Today, yesterday, 2 days ago have completions |
| Focus Time | 45 min | Only Task 1 has actualDuration |
| Completion Rate | 0.67 | 2/3 |
| Time Accuracy | from TimeAnalytics | Reuse existing calculation |

### Streak Test Cases

| Test Case | Input | Expected Streak |
|-----------|-------|-----------------|
| No tasks | [] | 0 |
| Today only, completed | [{today, completed: true}] | 1 |
| Today only, not completed | [{today, completed: false}] | 0 |
| Today + yesterday completed | [today✓, yesterday✓] | 2 |
| Gap yesterday | [today✓, 2-days-ago✓] | 1 |
| Midnight edge (11:59 PM + 12:01 AM) | Both same date | 1 (same day) |

---

## Test File Locations

Per project standards (`__tests__` directories or `.test.ts` files):

```
src/hooks/__tests__/useQuickStats.test.ts          # Unit tests (UNIT-001 to UNIT-020)
src/components/__tests__/QuickStatsWidget.test.tsx # Integration tests
src/components/__tests__/MilestoneToast.test.tsx   # Milestone tests
e2e/quick-stats.spec.ts                            # E2E tests (Playwright)
```

---

## Testing Tools & Patterns

- **Unit**: Vitest + @testing-library/react-hooks
- **Integration**: Vitest + React Testing Library
- **E2E**: Playwright
- **Performance**: React DevTools Profiler, `console.time/timeEnd`
- **Mocking**: Vitest mocks for `localStorage`, `Date`

### Date Mocking Pattern

```typescript
import { vi, beforeEach, afterEach } from 'vitest';

beforeEach(() => {
  // Mock "now" to a specific date for streak testing
  vi.useFakeTimers();
  vi.setSystemTime(new Date('2025-12-03T14:00:00Z'));
});

afterEach(() => {
  vi.useRealTimers();
});
```

### localStorage Mock Pattern

```typescript
const localStorageMock = {
  getItem: vi.fn(),
  setItem: vi.fn(),
  removeItem: vi.fn(),
  clear: vi.fn(),
};
Object.defineProperty(window, 'localStorage', { value: localStorageMock });
```

---

## Performance Test Specification

### 2.5-PERF-001: Dual Widget Render Performance

**Objective:** Verify QuickStatsWidget + TimeAnalyticsWidget don't cause excessive re-renders

**Method:**
1. Mount both widgets
2. Complete a task
3. Measure re-render count for both widgets
4. Verify total re-renders ≤ 4 (2 per widget)

**Pass Criteria:**
- Each widget re-renders ≤ 2 times per task completion
- No frame drops (maintain 60fps)
- Total recalculation time < 16ms

```typescript
// Using React Profiler
const onRenderCallback = (id, phase, actualDuration) => {
  expect(actualDuration).toBeLessThan(16); // 16ms = 60fps budget
};

<Profiler id="QuickStatsWidget" onRender={onRenderCallback}>
  <QuickStatsWidget />
</Profiler>
```

---

## Quality Checklist Verification

- [x] Every AC has test coverage (32 scenarios across 10 ACs)
- [x] Test levels are appropriate (unit for logic, integration for components)
- [x] No duplicate coverage across levels
- [x] Priorities align with risk profile (streak tests = P0, UI polish = P2)
- [x] Test IDs follow naming convention (2.5-LEVEL-SEQ)
- [x] Scenarios are atomic and independent
- [x] High-risk items (DATA-001) have multiple test angles
- [x] Edge cases documented with expected values

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 32
  by_level:
    unit: 18
    integration: 10
    e2e: 4
  by_priority:
    p0: 8
    p1: 14
    p2: 8
    p3: 2
  coverage_gaps: []
  risk_coverage:
    data_001: 4 tests
    perf_001: 1 test
    ux_001: 1 test
```

---

## Appendix: Streak Algorithm Test Matrix

| Day | Has Completed Task | Expected Current Streak |
|-----|-------------------|------------------------|
| Today (D0) | ✓ | 1 |
| Yesterday (D-1) | ✓ | 2 (D0 + D-1) |
| D-2 | ✓ | 3 |
| D-3 | ✗ (gap) | 3 (streak broken here) |
| D-4 | ✓ | 3 (doesn't count, gap before) |
| D-5 | ✓ | 3 |
| D-6 | ✓ | 3 |

**Longest streak in this data:** Could be longer if D-4 to D-6 were consecutive (3 days)

---

**Test design matrix:** `docs/qa/assessments/2.5-test-design-20251203.md`  
**P0 tests identified:** 8  
**Risk DATA-001 test coverage:** 4 dedicated tests

