# Risk Profile: Story 1.1 - Smart Notifications System

**Date:** 2025-12-02  
**Reviewer:** Quinn (Test Architect)  
**Story:** 1.1 Smart Notifications System  
**Epic:** Foundation & Quick Wins

---

## Executive Summary

| Metric | Value |
|--------|-------|
| **Total Risks Identified** | 8 |
| **Critical Risks** | 0 |
| **High Risks** | 2 |
| **Medium Risks** | 4 |
| **Low Risks** | 2 |
| **Risk Score** | 66/100 |

This story has **moderate-to-high complexity** due to browser API variations, timing precision requirements, and cross-browser compatibility needs. No critical risks were identified, but two high-risk items require careful attention during implementation.

---

## Risk Matrix

| Risk ID   | Description                                      | Probability | Impact     | Score | Priority |
|-----------|--------------------------------------------------|-------------|------------|-------|----------|
| TECH-001  | Cross-browser Web Notifications API differences  | High (3)    | Medium (2) | 6     | High     |
| TECH-002  | Notification timing drift with setTimeout        | Medium (2)  | High (3)   | 6     | High     |
| TECH-003  | Service Worker coordination complexity           | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001  | localStorage quota exceeded for preferences      | Low (1)     | Medium (2) | 2     | Low      |
| OPS-001   | Duplicate notification detection edge cases      | Medium (2)  | Medium (2) | 4     | Medium   |
| SEC-001   | Notification permission spoofing in development  | Low (1)     | Low (1)    | 1     | Minimal  |
| BUS-001   | User denies permission - degraded experience     | High (3)    | Low (1)    | 3     | Low      |
| PERF-001  | Multiple timers causing memory pressure          | Medium (2)  | Medium (2) | 4     | Medium   |

---

## Critical & High Risks Requiring Attention

### TECH-001: Cross-browser Web Notifications API Differences

**Score: 6 (High)**

**Probability:** High - Browser implementations of the Notifications API vary significantly, especially Safari which has different permission flow and feature support.

**Impact:** Medium - Users on certain browsers may have degraded or non-functional notifications, leading to missed tasks.

**Affected Components:**
- `NotificationService` (new)
- Permission request flow
- Notification display logic

**Mitigation:**
| Strategy | Actions |
|----------|---------|
| **Preventive** | Feature detection before using Notification API |
| **Preventive** | Use `Notification.permission` check pattern consistently |
| **Preventive** | Implement Safari-specific fallbacks (Safari requires user gesture for permission) |
| **Detective** | Log browser/version when notifications fail |

**Testing Requirements:**
- Manual testing on Chrome, Firefox, Safari, Edge (latest 2 versions each)
- Automated Playwright tests for permission flow
- Test Safari's user-gesture requirement specifically

---

### TECH-002: Notification Timing Drift with setTimeout

**Score: 6 (High)**

**Probability:** Medium - JavaScript's `setTimeout` is not guaranteed to fire at exact intervals. Browser throttling in background tabs can delay timers by minutes.

**Impact:** High - Users may receive "15 minutes before" notification only 5 minutes before, or miss the start-time notification entirely.

**Affected Components:**
- `NotificationService` scheduling logic
- Timer management system

**Mitigation:**
| Strategy | Actions |
|----------|---------|
| **Preventive** | Use polling approach (check every 30s) instead of long setTimeout |
| **Preventive** | Calculate notification times on each poll using `Date.now()` |
| **Preventive** | Consider using Service Worker `push` or `periodicsync` for background reliability |
| **Corrective** | Send notification if within tolerance window (±30 seconds of target time) |

**Testing Requirements:**
- Unit tests for time calculation logic
- Manual testing with browser tab in background
- Test with system sleep/wake cycles
- Verify notifications fire within acceptable tolerance

---

## Medium Risk Details

### TECH-003: Service Worker Coordination Complexity

**Score: 4 (Medium)**

**Description:** PWA service worker is already configured via `vite-plugin-pwa`. Coordinating between main thread notifications and service worker notifications adds complexity.

**Mitigation:**
- Start with main-thread notifications only (MVP)
- Service worker notifications can be added in Epic 3 (PWA excellence)
- Document decision in technical notes

---

### OPS-001: Duplicate Notification Detection Edge Cases

**Score: 4 (Medium)**

**Description:** AC #10 requires no duplicate notifications. Edge cases include: page reload, multiple tabs, browser restart during scheduled notification window.

**Mitigation:**
- Use localStorage to track sent notifications with task ID + timestamp key
- Clear tracking data after notification time passes
- Handle multi-tab scenario with `BroadcastChannel` or leader election

---

### PERF-001: Multiple Timers Causing Memory Pressure

**Score: 4 (Medium)**

**Description:** Creating individual setTimeout for each notification (15min, 5min, start) for each task could create many timers.

**Mitigation:**
- Use single polling loop instead of individual timers
- Clean up timers properly on date change
- Limit active notifications to visible day only

---

## Low & Minimal Risk Details

### DATA-001: localStorage Quota for Preferences

**Score: 2 (Low)**

Notification preferences are small (<1KB). Risk is minimal given typical 5MB localStorage limit.

### BUS-001: User Denies Permission

**Score: 3 (Low)**

Users may deny notification permission. This is expected behavior.

**Mitigation:**
- Display clear message explaining value proposition before requesting
- Show in-app banner with instructions to enable if denied
- AC #8 covers this gracefully

### SEC-001: Notification Permission Spoofing

**Score: 1 (Minimal)**

Not a real concern - browser handles permission securely. Development HTTPS is already configured.

---

## Risk Distribution

### By Category

| Category | Count | High/Critical |
|----------|-------|---------------|
| Technical (TECH) | 3 | 2 |
| Operational (OPS) | 1 | 0 |
| Performance (PERF) | 1 | 0 |
| Data (DATA) | 1 | 0 |
| Business (BUS) | 1 | 0 |
| Security (SEC) | 1 | 0 |

### By Component

| Component | Risks |
|-----------|-------|
| NotificationService (new) | 5 |
| Settings/Preferences | 2 |
| Service Worker | 1 |

---

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests

| Test Type | Focus Area |
|-----------|------------|
| Cross-browser manual | Permission flow on Safari, Chrome, Firefox, Edge |
| Unit tests | Time calculation and tolerance logic |
| Integration | Polling loop accuracy over extended periods |

### Priority 2: Medium Risk Tests

| Test Type | Focus Area |
|-----------|------------|
| Unit tests | Duplicate detection logic |
| Multi-tab manual | BroadcastChannel coordination |
| Performance | Timer count and cleanup verification |

### Priority 3: Standard Tests

| Test Type | Focus Area |
|-----------|------------|
| Unit tests | Preference persistence in localStorage |
| E2E (Playwright) | Full notification flow happy path |
| Accessibility | Keyboard navigation to notification settings |

---

## Risk Acceptance Criteria

### Must Fix Before Production

- [ ] TECH-001: Cross-browser testing complete with documented support matrix
- [ ] TECH-002: Timing drift tested and within ±60 second tolerance

### Can Deploy with Monitoring

- [ ] OPS-001: Duplicate detection with monitoring for reports of duplicates
- [ ] PERF-001: Timer count logged; alert if >50 active

### Accepted Risks

- [ ] BUS-001: User denial - handled gracefully per AC #8
- [ ] SEC-001: No action needed - browser security sufficient

---

## Monitoring Requirements

Post-deployment monitoring for:

| Risk | Metric to Monitor |
|------|-------------------|
| TECH-001 | Error logs by browser/version for notification failures |
| TECH-002 | Notification timing delta (actual vs expected) |
| OPS-001 | User reports of duplicate notifications |
| PERF-001 | Active timer count on page; memory usage |

---

## Positive Findings

1. **PWA Infrastructure Ready:** `vite-plugin-pwa` is already configured with service worker support
2. **HTTPS Configured:** Development server has HTTPS, required for notifications
3. **Action Types Defined:** Schedule type already includes `Action` interface with message/channels
4. **Zustand Available:** State management pattern established for new settings store
5. **Toast System Exists:** `react-hot-toast` can be used for in-app fallback notifications

---

## Recommendations for Implementation

### Must Do

1. **Use polling approach** instead of long-running `setTimeout` to prevent timer drift
2. **Feature-detect** Notification API before use
3. **Test on Safari** specifically - different permission model

### Should Do

1. Start with main-thread notifications; defer service worker to Epic 3
2. Create `useSettingsStore` with notification preferences schema
3. Implement `BroadcastChannel` for multi-tab coordination

### Consider

1. Add visual indicator showing notification status (enabled/disabled/pending)
2. Include "Test Notification" button in settings for user verification

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 2
    medium: 4
    low: 2
  highest:
    id: TECH-001
    score: 6
    title: 'Cross-browser Web Notifications API differences'
  recommendations:
    must_fix:
      - 'Implement feature detection for Notifications API'
      - 'Use polling approach instead of long setTimeout'
      - 'Test on Safari with user-gesture requirement'
    monitor:
      - 'Notification timing delta logs'
      - 'Browser-specific error rates'
```

---

**Risk profile:** `docs/qa/assessments/1.1-risk-20251202.md`

