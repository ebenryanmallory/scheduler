# Test Design: Story 1.1 - Smart Notifications System

**Date:** 2025-12-02  
**Designer:** Quinn (Test Architect)  
**Story:** 1.1 Smart Notifications System  
**Epic:** Foundation & Quick Wins

---

## Test Strategy Overview

| Metric | Count | Percentage |
|--------|-------|------------|
| **Total Test Scenarios** | 28 | 100% |
| **Unit Tests** | 12 | 43% |
| **Integration Tests** | 10 | 36% |
| **E2E Tests** | 6 | 21% |

### Priority Distribution

| Priority | Count | Description |
|----------|-------|-------------|
| **P0** | 4 | Critical - must pass |
| **P1** | 14 | High - core functionality |
| **P2** | 8 | Medium - secondary features |
| **P3** | 2 | Low - edge cases |

---

## Test Scenarios by Acceptance Criteria

### AC1: Request notification permissions on first app load

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 1.1-UNIT-001 | Unit | P1 | Verify permission check logic returns correct status (granted/denied/default) | Pure logic - status interpretation |
| 1.1-INT-001 | Integration | P1 | NotificationService requests permission from browser API on first load | Component-to-browser API interaction |
| 1.1-INT-002 | Integration | P2 | Permission request only triggers once (check localStorage flag) | Service + storage interaction |
| 1.1-E2E-001 | E2E | P1 | Full permission flow - first visit user sees permission dialog | Critical user journey |

**Risk Coverage:** Mitigates TECH-001 (browser API differences)

---

### AC2: Send notifications 15 minutes before task starts

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 1.1-UNIT-002 | Unit | P0 | Calculate 15-minute-before timestamp correctly | Time calculation logic |
| 1.1-UNIT-003 | Unit | P1 | Handle timezone edge cases for 15-min calculation | Complex time logic |
| 1.1-INT-003 | Integration | P1 | Scheduler triggers notification at 15-min mark | Timer + notification interaction |

**Risk Coverage:** Mitigates TECH-002 (timing drift)

---

### AC3: Send notifications 5 minutes before task starts

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 1.1-UNIT-004 | Unit | P0 | Calculate 5-minute-before timestamp correctly | Time calculation logic |
| 1.1-INT-004 | Integration | P1 | Scheduler triggers notification at 5-min mark | Timer + notification interaction |

**Risk Coverage:** Mitigates TECH-002 (timing drift)

---

### AC4: Send notifications at exact task start time

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 1.1-UNIT-005 | Unit | P0 | Calculate exact start timestamp correctly | Time calculation logic |
| 1.1-INT-005 | Integration | P1 | Scheduler triggers notification at start time | Timer + notification interaction |
| 1.1-E2E-002 | E2E | P0 | Full notification sequence: 15min → 5min → start | Critical user journey, all timings |

**Risk Coverage:** Mitigates TECH-002 (timing drift)

---

### AC5: Allow users to customize notification timing in settings

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 1.1-UNIT-006 | Unit | P1 | Validate custom timing input (min/max bounds) | Input validation logic |
| 1.1-INT-006 | Integration | P2 | Settings UI updates NotificationService config | Component interaction |
| 1.1-INT-007 | Integration | P2 | Custom timing values used in scheduling | Settings → Scheduler flow |
| 1.1-E2E-003 | E2E | P2 | User changes timing preference, notifications respect new timing | Full settings flow |

---

### AC6: Parse and execute notification actions from schedule.json

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 1.1-UNIT-007 | Unit | P1 | Parse `actions` array from schedule activity | Data transformation |
| 1.1-UNIT-008 | Unit | P1 | Extract message and channels from action object | Data extraction logic |
| 1.1-INT-008 | Integration | P1 | NotificationService processes action types correctly | Service processes schedule data |

**Test Data:** Use existing `scheduleActivities.ts` as fixture

---

### AC7: Persist notification preferences in localStorage

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 1.1-UNIT-009 | Unit | P1 | Serialize/deserialize preferences correctly | Data transformation |
| 1.1-INT-009 | Integration | P1 | Preferences survive page reload | Storage persistence |
| 1.1-E2E-004 | E2E | P2 | Settings persist across browser sessions | Full persistence flow |

**Risk Coverage:** Mitigates DATA-001 (localStorage)

---

### AC8: Handle notification permission denial gracefully with clear messaging

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 1.1-UNIT-010 | Unit | P1 | Generate appropriate user message for denied state | Message logic |
| 1.1-INT-010 | Integration | P1 | UI displays fallback banner when permission denied | Component + service interaction |
| 1.1-E2E-005 | E2E | P1 | User denies permission, sees helpful enable instructions | User experience flow |

**Risk Coverage:** Mitigates BUS-001 (user denial)

---

### AC9: Work across Chrome, Firefox, Safari, and Edge browsers

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 1.1-UNIT-011 | Unit | P1 | Feature detection for Notification API support | Browser capability check |
| 1.1-E2E-006 | E2E | P1 | Cross-browser smoke test on 4 browsers | Browser compatibility critical |

**Risk Coverage:** Mitigates TECH-001 (cross-browser)

**Note:** E2E-006 requires Playwright multi-browser config:
- Chrome (latest, latest-1)
- Firefox (latest, latest-1)
- Safari (latest)
- Edge (latest)

---

### AC10: Do not send duplicate notifications for the same task

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 1.1-UNIT-012 | Unit | P1 | Generate unique notification key from task ID + time | Key generation logic |
| 1.1-INT-011 | Integration | P1 | Duplicate detection blocks second notification | Service deduplication |
| 1.1-INT-012 | Integration | P2 | Multi-tab scenario: BroadcastChannel prevents duplicates | Cross-tab coordination |

**Risk Coverage:** Mitigates OPS-001 (duplicate detection)

---

## Risk Coverage Matrix

| Risk ID | Risk Title | Test Coverage |
|---------|------------|---------------|
| TECH-001 | Cross-browser API differences | 1.1-INT-001, 1.1-UNIT-011, 1.1-E2E-006 |
| TECH-002 | Timing drift with setTimeout | 1.1-UNIT-002/004/005, 1.1-INT-003/004/005, 1.1-E2E-002 |
| TECH-003 | Service Worker coordination | Deferred to Epic 3 (out of scope for MVP) |
| DATA-001 | localStorage quota | 1.1-UNIT-009, 1.1-INT-009 |
| OPS-001 | Duplicate notifications | 1.1-UNIT-012, 1.1-INT-011/012 |
| BUS-001 | Permission denial | 1.1-UNIT-010, 1.1-INT-010, 1.1-E2E-005 |
| PERF-001 | Timer memory pressure | Implicit in integration tests (monitoring) |

---

## Test Data Requirements

### Fixtures Needed

```typescript
// test/fixtures/notifications.ts

export const mockScheduleActivity = {
  "08:00": {
    activity: "Focus Work",
    duration: 240,
    actions: [
      { type: "reminder", message: "Starting focus block", channels: ["text"] }
    ]
  }
};

export const mockNotificationPreferences = {
  enabled: true,
  timing: [15, 5, 0], // minutes before
  soundEnabled: true,
  channels: ["browser"]
};

export const mockTask = {
  id: "task-001",
  title: "Morning standup",
  scheduledTime: "09:00",
  project: "Test Project"
};
```

### Time Mocking

All timing tests require time mocking:
- Use `vi.useFakeTimers()` in Vitest
- Advance time with `vi.advanceTimersByTime(ms)`

---

## Recommended File Structure

```
src/
├── services/
│   └── notificationService.ts        # New service
│   └── notificationService.test.ts   # Unit tests
├── store/
│   └── settingsStore.ts              # New store  
│   └── settingsStore.test.ts         # Unit tests
├── components/
│   └── NotificationSettings.tsx      # New component
│   └── NotificationBanner.tsx        # Permission denied banner
tests/
├── integration/
│   └── notifications.test.ts         # Integration tests
├── e2e/
│   └── notifications.spec.ts         # Playwright E2E tests
├── fixtures/
│   └── notifications.ts              # Test data
```

---

## Recommended Execution Order

### CI Pipeline Order

```
1. P0 Unit Tests (fail fast)
   └── 1.1-UNIT-002, 1.1-UNIT-004, 1.1-UNIT-005 (timing calculations)

2. P1 Unit Tests
   └── All remaining UNIT tests

3. P0 Integration Tests  
   └── None (no P0 integration for this story)

4. P1 Integration Tests
   └── 1.1-INT-001 through 1.1-INT-011

5. P0 E2E Tests
   └── 1.1-E2E-002 (notification sequence)

6. P1 E2E Tests
   └── 1.1-E2E-001, 1.1-E2E-005, 1.1-E2E-006

7. P2 Tests (if time permits)
   └── Remaining P2 scenarios
```

### Manual Testing Required

| Browser | Tests | Notes |
|---------|-------|-------|
| Safari | Permission flow | Requires user gesture - cannot fully automate |
| All | Background tab timing | Verify notifications fire when tab is backgrounded |
| Mobile Safari | PWA notifications | iOS has unique restrictions |

---

## Test Implementation Notes

### Unit Test Approach

```typescript
// Example: 1.1-UNIT-002
describe('NotificationService', () => {
  describe('calculateNotificationTime', () => {
    it('calculates 15-minute-before timestamp correctly', () => {
      const taskTime = new Date('2025-12-02T09:00:00');
      const result = calculateNotificationTime(taskTime, 15);
      expect(result).toEqual(new Date('2025-12-02T08:45:00'));
    });
  });
});
```

### Integration Test Approach

```typescript
// Example: 1.1-INT-003
describe('Notification Scheduling', () => {
  beforeEach(() => {
    vi.useFakeTimers();
  });

  it('triggers notification at 15-min mark', async () => {
    const notifySpy = vi.spyOn(notificationService, 'show');
    scheduleNotification(task, 15);
    
    vi.advanceTimersByTime(15 * 60 * 1000);
    
    expect(notifySpy).toHaveBeenCalledWith(
      expect.objectContaining({ taskId: task.id })
    );
  });
});
```

### E2E Test Approach

```typescript
// Example: 1.1-E2E-002
test('notification sequence fires at correct intervals', async ({ page, context }) => {
  // Grant notification permission
  await context.grantPermissions(['notifications']);
  
  await page.goto('/');
  
  // Create task starting in 16 minutes
  await createTask(page, { scheduledTime: getFutureTime(16) });
  
  // Wait for 15-min notification
  const notification1 = await page.waitForEvent('notification');
  expect(notification1.title).toContain('15 minutes');
  
  // Continue for 5-min and start notifications...
});
```

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention (`{epic}.{story}-{LEVEL}-{SEQ}`)
- [x] Scenarios are atomic and independent
- [x] Risk mitigations are addressed

---

## Gate YAML Block

```yaml
# test_design (paste into gate file):
test_design:
  scenarios_total: 28
  by_level:
    unit: 12
    integration: 10
    e2e: 6
  by_priority:
    p0: 4
    p1: 14
    p2: 8
    p3: 2
  coverage_gaps: []
  risk_coverage:
    - TECH-001: 3 tests
    - TECH-002: 7 tests
    - DATA-001: 2 tests
    - OPS-001: 3 tests
    - BUS-001: 3 tests
```

---

## Dependencies for Implementation

Before test implementation, Dev should create:

1. `NotificationService` class/module
2. `useSettingsStore` with notification preferences
3. Time calculation utility functions
4. Permission request flow component

---

**Test design matrix:** `docs/qa/assessments/1.1-test-design-20251202.md`  
**P0 tests identified:** 4

