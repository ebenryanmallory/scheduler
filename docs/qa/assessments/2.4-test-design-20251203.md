# Test Design: Story 2.4 - Recurring Tasks and Templates

**Story**: 2.4 - Recurring Tasks and Templates  
**Designed by**: Quinn (Test Architect)  
**Date**: 2025-12-03  
**Status**: Test Design Complete

---

## Test Strategy

### Scope
Test the recurring task and template functionality:
- RRule library wrapper functions
- RecurrenceSelector component
- Template library CRUD operations
- Visual indicators for recurring tasks
- Import/export functionality

### Out of Scope (Deferred)
- Instance generation integration tests (feature not fully wired)
- Edit/delete scope selection integration (dialogs not wired)

### Testing Levels
| Level | Focus | Tools |
|-------|-------|-------|
| Unit | RRule utilities, validation | Vitest |
| Integration | RecurrenceSelector, TemplateLibrary | Vitest + RTL |
| E2E | Create recurring task, use template | Playwright |

---

## Acceptance Criteria Traceability

| AC | Description | Test IDs |
|----|-------------|----------|
| AC1 | Recurrence options in dialog | T-01, T-02, I-01 |
| AC2 | Custom recurrence patterns | T-03, T-04, T-05, I-02 |
| AC3 | Auto-generate instances | T-06, T-07, T-08 |
| AC4 | Edit instance vs series | T-09 (dialog only) |
| AC5 | Delete instance vs series | T-10 (dialog only) |
| AC6 | Template library accessible | I-03, I-04 |
| AC7 | Import from schedule.json | T-11, T-12 |
| AC8 | Create template from task | T-13, I-05 |
| AC9 | Export/import templates | T-14, T-15, T-16, I-06 |
| AC10 | RRule library usage | T-17, T-18, T-19 |
| AC11 | Visual indicators | T-20, I-07 |

---

## Unit Tests

### RRule Utilities (src/lib/recurrence.ts)

#### T-01: createRRule generates daily rule
```typescript
test('should create daily recurrence rule', () => {
  const config: RecurrenceConfig = {
    frequency: 'daily',
    interval: 1,
    endType: 'never',
  }
  const rule = createRRule(config, new Date('2025-12-01'))
  
  expect(rule.options.freq).toBe(RRule.DAILY)
  expect(rule.options.interval).toBe(1)
})
```
**Priority**: P0 | **Risk Coverage**: AC10

#### T-02: createRRule generates weekly with days
```typescript
test('should create weekly rule with specific days', () => {
  const config: RecurrenceConfig = {
    frequency: 'weekly',
    interval: 1,
    byWeekday: ['MO', 'WE', 'FR'],
    endType: 'never',
  }
  const rule = createRRule(config)
  
  expect(rule.options.byweekday).toHaveLength(3)
})
```
**Priority**: P0 | **Risk Coverage**: AC2

#### T-03: parseRRuleString parses valid string
```typescript
test('should parse valid RRule string back to config', () => {
  const rruleString = 'DTSTART:20251201T000000Z\nRRULE:FREQ=WEEKLY;INTERVAL=2;BYDAY=MO,FR'
  const config = parseRRuleString(rruleString)
  
  expect(config).not.toBeNull()
  expect(config?.frequency).toBe('weekly')
  expect(config?.interval).toBe(2)
  expect(config?.byWeekday).toContain('MO')
  expect(config?.byWeekday).toContain('FR')
})
```
**Priority**: P0 | **Risk Coverage**: AC10, TECH-004

#### T-04: parseRRuleString returns null for invalid string
```typescript
test('should return null for invalid RRule string', () => {
  const config = parseRRuleString('INVALID_STRING')
  
  expect(config).toBeNull()
})
```
**Priority**: P1 | **Risk Coverage**: TECH-004

#### T-05: configToRRuleString round-trips correctly
```typescript
test('should round-trip config through RRule string', () => {
  const original: RecurrenceConfig = {
    frequency: 'monthly',
    interval: 1,
    byMonthDay: 15,
    endType: 'count',
    count: 12,
  }
  const rruleString = configToRRuleString(original)
  const parsed = parseRRuleString(rruleString)
  
  expect(parsed?.frequency).toBe(original.frequency)
  expect(parsed?.interval).toBe(original.interval)
  expect(parsed?.byMonthDay).toBe(original.byMonthDay)
  expect(parsed?.count).toBe(original.count)
})
```
**Priority**: P0 | **Risk Coverage**: AC2

#### T-06: getNextOccurrences returns correct count
```typescript
test('should return correct number of next occurrences', () => {
  const config: RecurrenceConfig = {
    frequency: 'daily',
    interval: 1,
    endType: 'never',
  }
  const rruleString = configToRRuleString(config, new Date('2025-12-01'))
  const occurrences = getNextOccurrences(rruleString, 5, new Date('2025-12-01'))
  
  expect(occurrences).toHaveLength(5)
})
```
**Priority**: P0 | **Risk Coverage**: AC3

#### T-07: getOccurrencesInRange respects exdates
```typescript
test('should exclude exception dates from occurrences', () => {
  const config: RecurrenceConfig = {
    frequency: 'daily',
    interval: 1,
    endType: 'never',
  }
  const rruleString = configToRRuleString(config, new Date('2025-12-01'))
  const start = new Date('2025-12-01')
  const end = new Date('2025-12-10')
  const exdates = ['2025-12-05']
  
  const occurrences = getOccurrencesInRange(rruleString, start, end, exdates)
  
  const dateStrings = occurrences.map(d => d.toISOString().split('T')[0])
  expect(dateStrings).not.toContain('2025-12-05')
})
```
**Priority**: P0 | **Risk Coverage**: AC5

#### T-08: generateRecurringInstances creates instances with correct IDs
```typescript
test('should generate instances with unique IDs', () => {
  const masterTask = {
    id: 'task-123',
    date: '2025-12-01',
    recurrence: {
      rruleString: configToRRuleString({ frequency: 'daily', interval: 1, endType: 'never' }),
      isInstance: false,
    },
  }
  const instances = generateRecurringInstances(masterTask, new Date('2025-12-05'))
  
  expect(instances.length).toBeGreaterThan(0)
  instances.forEach(instance => {
    expect(instance.id).toMatch(/^task-123-\d{4}-\d{2}-\d{2}$/)
    expect(instance.recurrence.parentSeriesId).toBe('task-123')
    expect(instance.recurrence.isInstance).toBe(true)
  })
})
```
**Priority**: P0 | **Risk Coverage**: AC3

#### T-09: RecurrenceEditDialog shows three scope options
```typescript
test('should render all three edit scope options', () => {
  render(<RecurrenceEditDialog open={true} onOpenChange={vi.fn()} onSelect={vi.fn()} taskTitle="Test" />)
  
  expect(screen.getByText('This occurrence only')).toBeInTheDocument()
  expect(screen.getByText('This and future occurrences')).toBeInTheDocument()
  expect(screen.getByText('All occurrences')).toBeInTheDocument()
})
```
**Priority**: P1 | **Risk Coverage**: AC4

#### T-10: RecurrenceDeleteDialog shows three scope options
```typescript
test('should render all three delete scope options', () => {
  render(<RecurrenceDeleteDialog open={true} onOpenChange={vi.fn()} onSelect={vi.fn()} taskTitle="Test" />)
  
  expect(screen.getByText('This occurrence only')).toBeInTheDocument()
  expect(screen.getByText('This and future occurrences')).toBeInTheDocument()
  expect(screen.getByText('All occurrences')).toBeInTheDocument()
})
```
**Priority**: P1 | **Risk Coverage**: AC5

### Template Store Tests

#### T-11: loadBuiltInTemplates adds 8 templates
```typescript
test('should load 8 built-in templates', () => {
  const store = useTemplateStore.getState()
  store.loadBuiltInTemplates()
  
  const builtIn = store.templates.filter(t => t.isBuiltIn)
  expect(builtIn).toHaveLength(8)
})
```
**Priority**: P0 | **Risk Coverage**: AC7

#### T-12: Built-in templates have correct categories
```typescript
test('should have templates in expected categories', () => {
  const store = useTemplateStore.getState()
  store.loadBuiltInTemplates()
  
  const categories = new Set(store.templates.map(t => t.category))
  expect(categories).toContain('Routines')
  expect(categories).toContain('Health')
  expect(categories).toContain('Productivity')
  expect(categories).toContain('Work')
})
```
**Priority**: P1 | **Risk Coverage**: AC7

#### T-13: createTemplateFromTask creates custom template
```typescript
test('should create template from task', () => {
  const store = useTemplateStore.getState()
  const task: Partial<TaskType> = {
    title: 'My Task',
    description: 'Task description',
    estimatedDuration: 30,
    project: 'Work',
  }
  
  store.createTemplateFromTask(task as TaskType, 'My Template')
  
  const template = store.templates.find(t => t.name === 'My Template')
  expect(template).toBeDefined()
  expect(template?.taskDefaults.title).toBe('My Task')
  expect(template?.isBuiltIn).toBe(false)
})
```
**Priority**: P0 | **Risk Coverage**: AC8

#### T-14: exportTemplates excludes built-in by default
```typescript
test('should exclude built-in templates from export', () => {
  const store = useTemplateStore.getState()
  store.loadBuiltInTemplates()
  store.addTemplate({ name: 'Custom', taskDefaults: {}, isBuiltIn: false })
  
  const exported = store.exportTemplates()
  
  expect(exported.templates.every(t => !t.isBuiltIn)).toBe(true)
})
```
**Priority**: P1 | **Risk Coverage**: AC9

#### T-15: importTemplates skips duplicates
```typescript
test('should skip templates with duplicate names', () => {
  const store = useTemplateStore.getState()
  store.addTemplate({ name: 'Existing', taskDefaults: {}, isBuiltIn: false })
  
  const importData: TemplateExport = {
    version: '1.0',
    exportedAt: new Date().toISOString(),
    templates: [
      { id: '1', name: 'Existing', taskDefaults: {}, isBuiltIn: false, createdAt: '' },
      { id: '2', name: 'New', taskDefaults: {}, isBuiltIn: false, createdAt: '' },
    ],
  }
  
  const result = store.importTemplates(importData)
  
  expect(result.imported).toBe(1)
  expect(result.skipped).toBe(1)
})
```
**Priority**: P1 | **Risk Coverage**: AC9, DATA-001

#### T-16: importTemplates rejects wrong version
```typescript
test('should reject import with wrong version', () => {
  const store = useTemplateStore.getState()
  
  const importData = {
    version: '2.0',
    exportedAt: new Date().toISOString(),
    templates: [],
  }
  
  const result = store.importTemplates(importData)
  
  expect(result.imported).toBe(0)
  expect(store.error).toContain('Unsupported')
})
```
**Priority**: P2 | **Risk Coverage**: AC9

### Validation Tests

#### T-17: isValidRecurrence rejects interval < 1
```typescript
test('should reject interval less than 1', () => {
  const config: RecurrenceConfig = {
    frequency: 'daily',
    interval: 0,
    endType: 'never',
  }
  
  expect(isValidRecurrence(config)).toBe(false)
})
```
**Priority**: P1 | **Risk Coverage**: TECH-005

#### T-18: isValidRecurrence rejects weekly without days
```typescript
test('should reject weekly without byWeekday', () => {
  const config: RecurrenceConfig = {
    frequency: 'weekly',
    interval: 1,
    byWeekday: [],
    endType: 'never',
  }
  
  expect(isValidRecurrence(config)).toBe(false)
})
```
**Priority**: P1 | **Risk Coverage**: TECH-005

#### T-19: describeRecurrence returns human-readable text
```typescript
test('should return human-readable description', () => {
  const rruleString = configToRRuleString({
    frequency: 'weekly',
    interval: 1,
    byWeekday: ['MO', 'WE', 'FR'],
    endType: 'never',
  })
  
  const description = describeRecurrence(rruleString)
  
  expect(description.toLowerCase()).toContain('week')
})
```
**Priority**: P2 | **Risk Coverage**: AC11

#### T-20: isRecurring detects recurring tasks
```typescript
test('should detect recurring master task', () => {
  const recurrence: RecurrenceRule = {
    rruleString: 'RRULE:FREQ=DAILY',
    isInstance: false,
  }
  
  expect(isRecurring(recurrence)).toBe(true)
  expect(isRecurringMaster(recurrence)).toBe(true)
  expect(isRecurringInstance(recurrence)).toBe(false)
})
```
**Priority**: P1 | **Risk Coverage**: AC11

---

## Integration Tests

### I-01: RecurrenceSelector preset selection
```typescript
test('clicking Daily preset sets daily recurrence', async () => {
  const onChange = vi.fn()
  render(<RecurrenceSelector value={null} onChange={onChange} />)
  
  // Expand selector
  await userEvent.click(screen.getByRole('button'))
  // Select Daily
  await userEvent.click(screen.getByText('Daily'))
  
  expect(onChange).toHaveBeenCalledWith(expect.objectContaining({
    frequency: 'daily',
    interval: 1,
  }))
})
```
**Priority**: P0

### I-02: RecurrenceSelector custom builder
```typescript
test('custom builder allows weekday selection', async () => {
  const onChange = vi.fn()
  render(<RecurrenceSelector value={null} onChange={onChange} />)
  
  await userEvent.click(screen.getByRole('button'))
  await userEvent.click(screen.getByText('Custom'))
  await userEvent.click(screen.getByText('Mon'))
  await userEvent.click(screen.getByText('Wed'))
  
  expect(onChange).toHaveBeenLastCalledWith(expect.objectContaining({
    byWeekday: expect.arrayContaining(['MO', 'WE']),
  }))
})
```
**Priority**: P0

### I-03: TemplateLibrary displays built-in templates
```typescript
test('should display built-in templates', async () => {
  render(<TemplateLibrary open={true} onOpenChange={vi.fn()} onSelectTemplate={vi.fn()} />)
  
  await waitFor(() => {
    expect(screen.getByText('Morning Routine')).toBeInTheDocument()
    expect(screen.getByText('Weekly Review')).toBeInTheDocument()
  })
})
```
**Priority**: P0

### I-04: TemplateLibrary category filtering
```typescript
test('should filter templates by category', async () => {
  render(<TemplateLibrary open={true} onOpenChange={vi.fn()} onSelectTemplate={vi.fn()} />)
  
  await userEvent.click(screen.getByText('Health'))
  
  expect(screen.getByText('Exercise Session')).toBeInTheDocument()
  expect(screen.queryByText('Morning Routine')).not.toBeInTheDocument()
})
```
**Priority**: P1

### I-05: CreateTaskDialog applies template
```typescript
test('selecting template pre-fills form fields', async () => {
  render(<CreateTaskDialog open={true} onOpenChange={vi.fn()} />)
  
  await userEvent.click(screen.getByText('Templates'))
  await userEvent.click(screen.getByText('Deep Work Block'))
  
  expect(screen.getByDisplayValue('Deep Work')).toBeInTheDocument()
})
```
**Priority**: P0

### I-06: TemplateLibrary export/import flow
```typescript
test('exported templates can be imported', async () => {
  // This is a complex flow better suited for E2E
})
```
**Priority**: P1

### I-07: Task shows recurring indicator
```typescript
test('recurring task shows repeat icon with tooltip', async () => {
  const task = {
    ...mockTask,
    recurrence: {
      rruleString: 'RRULE:FREQ=DAILY',
      isInstance: false,
    },
  }
  render(<Task {...task} />)
  
  const repeatIcon = screen.getByTitle(/recurring/i) || screen.getByLabelText(/recurring/i)
  expect(repeatIcon).toBeInTheDocument()
})
```
**Priority**: P1

---

## E2E Tests

### E-01: Create recurring task flow
```typescript
test('user can create a recurring task', async ({ page }) => {
  await page.goto('/')
  
  // Click to create task
  await page.click('[data-testid="add-task"]')
  
  // Fill title
  await page.fill('[name="title"]', 'Daily Standup')
  
  // Set recurrence
  await page.click('text=Does not repeat')
  await page.click('text=Daily')
  
  // Submit
  await page.click('text=Create Task')
  
  // Verify task appears with recurring indicator
  const task = page.locator('text=Daily Standup')
  await expect(task).toBeVisible()
  // Check for repeat icon nearby
})
```
**Priority**: P0

### E-02: Use template to create task
```typescript
test('user can create task from template', async ({ page }) => {
  await page.goto('/')
  
  await page.click('[data-testid="add-task"]')
  await page.click('text=Templates')
  await page.click('text=Weekly Review')
  
  // Form should be pre-filled
  await expect(page.locator('[name="title"]')).toHaveValue('Weekly Review')
  
  await page.click('text=Create Task')
  await expect(page.locator('text=Weekly Review')).toBeVisible()
})
```
**Priority**: P0

---

## Test Summary

| Level | Total | P0 | P1 | P2 |
|-------|-------|----|----|-----|
| Unit | 20 | 9 | 9 | 2 |
| Integration | 7 | 3 | 4 | 0 |
| E2E | 2 | 2 | 0 | 0 |
| **Total** | **29** | **14** | **13** | **2** |

---

## Coverage Gaps

| Area | Gap | Recommendation |
|------|-----|----------------|
| Instance generation | Not integrated into store | Test when feature is wired |
| Edit/delete scope | Dialogs exist but not wired | Test when feature is wired |
| Timezone/DST | Complex to test | Manual testing recommended |

---

## Test Implementation Status

â¬œ Not Started - Tests designed but implementation deferred per MVP scope

**Recommendation**: Implement P0 tests (14 scenarios) before production release.

