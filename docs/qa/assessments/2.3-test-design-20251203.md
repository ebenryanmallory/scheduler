# Test Design: Story 2.3 - Drag and Drop Task Scheduling

**Story**: 2.3 - Drag and Drop Task Scheduling  
**Designed by**: Quinn (Test Architect)  
**Date**: 2025-12-03  
**Status**: Test Design Complete

---

## Test Strategy

### Scope
Test the cross-container drag-and-drop functionality for scheduling tasks into time blocks, including:
- Dragging tasks from task list to time blocks
- Dragging tasks between time blocks
- Unscheduling tasks by dragging to task list
- Visual feedback during drag operations
- Undo functionality
- Confirmation dialog for significant changes
- Touch device support

### Out of Scope (Deferred)
- Task resizing (AC6) - deferred to future story
- Automated E2E tests with real touch devices

### Testing Levels
| Level | Focus | Tools |
|-------|-------|-------|
| Unit | Hook logic, utilities | Vitest |
| Integration | Component interactions | Vitest + RTL |
| E2E | User flows | Playwright |
| Manual | Touch, cross-browser | Device lab |

---

## Acceptance Criteria Traceability

| AC | Description | Test IDs |
|----|-------------|----------|
| AC1 | Drag tasks from list to time blocks | T-01, T-02, T-03, I-01 |
| AC2 | Drag tasks between time blocks | T-04, T-05, I-02 |
| AC3 | Visual feedback during drag | T-06, T-07, I-03 |
| AC4 | Update task time on drop | T-08, T-09, I-04 |
| AC5 | Snap to time block boundaries | T-10, I-05 |
| AC6 | Task resizing | DEFERRED |
| AC7 | Prevent invalid drops | T-11, T-12, I-06 |
| AC8 | Touch support | M-01, M-02, M-03 |
| AC9 | Undo functionality | T-13, T-14, T-15, T-16, I-07 |
| AC10 | Server persistence | T-17, I-08, E-01 |
| AC11 | Confirmation dialog | T-18, T-19, I-09, E-02 |

---

## Unit Tests

### useDragDropSchedule Hook

#### T-01: Initialize drag state on drag start
```typescript
test('should set activeTask and dragSource when drag starts', () => {
  const tasks = [mockTask({ id: '1', scheduledTime: undefined })]
  const { result } = renderHook(() => useDragDropSchedule({ tasks, ...handlers }))
  
  act(() => {
    result.current.handlers.onDragStart({ active: { id: '1' } })
  })
  
  expect(result.current.dragState.activeTask).toEqual(tasks[0])
  expect(result.current.dragState.dragSource).toBe('task-list')
})
```
**Priority**: P0 | **Risk Coverage**: TECH-002

#### T-02: Detect drag source from scheduled task
```typescript
test('should set dragSource to time-block when task has scheduledTime', () => {
  const tasks = [mockTask({ id: '1', scheduledTime: '2025-12-03T09:00:00' })]
  const { result } = renderHook(() => useDragDropSchedule({ tasks, ...handlers }))
  
  act(() => {
    result.current.handlers.onDragStart({ active: { id: '1' } })
  })
  
  expect(result.current.dragState.dragSource).toBe('time-block')
})
```
**Priority**: P1

#### T-03: Handle unknown task drag start gracefully
```typescript
test('should not crash when dragging unknown task', () => {
  const { result } = renderHook(() => useDragDropSchedule({ tasks: [], ...handlers }))
  
  act(() => {
    result.current.handlers.onDragStart({ active: { id: 'unknown' } })
  })
  
  expect(result.current.dragState.activeTask).toBeNull()
})
```
**Priority**: P1

#### T-04: Update overTarget when dragging over time block
```typescript
test('should set overTarget to time-block when hovering over time block', () => {
  const { result } = renderHook(() => useDragDropSchedule({ tasks: [mockTask()], ...handlers }))
  
  act(() => {
    result.current.handlers.onDragOver({ over: { id: 'time-block-2025-12-03T10:00:00' } })
  })
  
  expect(result.current.dragState.overTarget).toBe('time-block')
  expect(result.current.dragState.dropTime).toBe('10:00')
})
```
**Priority**: P0

#### T-05: Clear overTarget when not over drop zone
```typescript
test('should clear overTarget when not hovering over anything', () => {
  const { result } = renderHook(() => useDragDropSchedule({ tasks: [mockTask()], ...handlers }))
  
  act(() => {
    result.current.handlers.onDragOver({ over: null })
  })
  
  expect(result.current.dragState.overTarget).toBeNull()
})
```
**Priority**: P1

#### T-06: TaskDragPreview shows drop time when over time block
```typescript
test('should render drop time indicator when over time block', () => {
  render(<TaskDragPreview task={mockTask()} dropTime="10:00" isOverTimeBlock={true} />)
  
  expect(screen.getByText('10:00 AM')).toBeInTheDocument()
})
```
**Priority**: P1 | **Risk Coverage**: UX-001

#### T-07: TaskDragPreview hides drop time when not over time block
```typescript
test('should not render drop time when not over time block', () => {
  render(<TaskDragPreview task={mockTask()} dropTime={null} isOverTimeBlock={false} />)
  
  expect(screen.queryByText(/AM|PM/)).not.toBeInTheDocument()
})
```
**Priority**: P2

#### T-08: Call onTaskSchedule when dropped on time block
```typescript
test('should call onTaskSchedule with correct time on drop', async () => {
  const onTaskSchedule = vi.fn()
  const { result } = renderHook(() => useDragDropSchedule({ 
    tasks: [mockTask({ id: '1' })], 
    onTaskSchedule,
    ...otherHandlers 
  }))
  
  act(() => {
    result.current.handlers.onDragStart({ active: { id: '1' } })
  })
  
  await act(async () => {
    await result.current.handlers.onDragEnd({ 
      active: { id: '1' }, 
      over: { id: 'time-block-2025-12-03T14:30:00' } 
    })
  })
  
  expect(onTaskSchedule).toHaveBeenCalledWith('1', '2025-12-03T14:30:00')
})
```
**Priority**: P0 | **Risk Coverage**: DATA-001

#### T-09: Call onTaskUnschedule when dropped on task list
```typescript
test('should call onTaskUnschedule when scheduled task dropped on task list', async () => {
  const onTaskUnschedule = vi.fn()
  const { result } = renderHook(() => useDragDropSchedule({ 
    tasks: [mockTask({ id: '1', scheduledTime: '2025-12-03T09:00:00' })], 
    onTaskUnschedule,
    ...otherHandlers 
  }))
  
  act(() => {
    result.current.handlers.onDragStart({ active: { id: '1' } })
  })
  
  await act(async () => {
    await result.current.handlers.onDragEnd({ 
      active: { id: '1' }, 
      over: { id: 'task-list-drop-zone' } 
    })
  })
  
  expect(onTaskUnschedule).toHaveBeenCalledWith('1')
})
```
**Priority**: P0

#### T-10: Extract time from ISO timestamp correctly
```typescript
test('should parse time from time block ID', () => {
  const { result } = renderHook(() => useDragDropSchedule({ tasks: [mockTask()], ...handlers }))
  
  act(() => {
    result.current.handlers.onDragOver({ over: { id: 'time-block-2025-12-03T09:30:00' } })
  })
  
  expect(result.current.dragState.dropTime).toBe('09:30')
})
```
**Priority**: P1 | **Risk Coverage**: AC5

#### T-11: Reset state on drag cancel
```typescript
test('should reset all drag state on cancel', () => {
  const { result } = renderHook(() => useDragDropSchedule({ tasks: [mockTask()], ...handlers }))
  
  act(() => {
    result.current.handlers.onDragStart({ active: { id: '1' } })
  })
  
  act(() => {
    result.current.handlers.onDragCancel()
  })
  
  expect(result.current.dragState.activeTask).toBeNull()
  expect(result.current.dragState.overTarget).toBeNull()
})
```
**Priority**: P1

#### T-12: Prioritize time block in collision detection
```typescript
test('collision detection should prioritize time-block collisions', () => {
  const collisionDetection = createScheduleCollisionDetection()
  
  const result = collisionDetection({
    collisionRect: mockRect,
    droppableRects: new Map([
      ['task-1', mockRect],
      ['time-block-09:00', mockRect],
    ]),
    droppableContainers: mockContainers,
    active: { id: 'dragged' },
    pointerCoordinates: { x: 100, y: 100 },
  })
  
  expect(result[0]?.id).toBe('time-block-09:00')
})
```
**Priority**: P2

### useDragHistory Hook

#### T-13: Record operation in history
```typescript
test('should add operation to history on record', () => {
  const { result } = renderHook(() => useDragHistory({ onUndo: vi.fn() }))
  
  act(() => {
    result.current.recordOperation(
      mockTask({ id: '1', scheduledTime: undefined }),
      '2025-12-03T10:00:00',
      undefined
    )
  })
  
  expect(result.current.history).toHaveLength(1)
  expect(result.current.canUndo).toBe(true)
})
```
**Priority**: P0 | **Risk Coverage**: AC9

#### T-14: Limit history to 5 operations
```typescript
test('should limit history to MAX_HISTORY_SIZE (5)', () => {
  const { result } = renderHook(() => useDragHistory({ onUndo: vi.fn() }))
  
  act(() => {
    for (let i = 0; i < 7; i++) {
      result.current.recordOperation(mockTask({ id: `${i}` }), `10:0${i}`, undefined)
    }
  })
  
  expect(result.current.history).toHaveLength(5)
})
```
**Priority**: P1

#### T-15: Undo calls onUndo with previous state
```typescript
test('should call onUndo with previous scheduledTime on undoLast', async () => {
  const onUndo = vi.fn()
  const { result } = renderHook(() => useDragHistory({ onUndo }))
  
  act(() => {
    result.current.recordOperation(
      mockTask({ id: '1', scheduledTime: '2025-12-03T09:00:00' }),
      '2025-12-03T14:00:00',
      undefined
    )
  })
  
  await act(async () => {
    await result.current.undoLast()
  })
  
  expect(onUndo).toHaveBeenCalledWith('1', { scheduledTime: '2025-12-03T09:00:00', timeBlock: undefined })
})
```
**Priority**: P0 | **Risk Coverage**: AC9

#### T-16: Clear history removes all operations
```typescript
test('should clear all history on clearHistory', () => {
  const { result } = renderHook(() => useDragHistory({ onUndo: vi.fn() }))
  
  act(() => {
    result.current.recordOperation(mockTask(), '10:00', undefined)
    result.current.clearHistory()
  })
  
  expect(result.current.history).toHaveLength(0)
  expect(result.current.canUndo).toBe(false)
})
```
**Priority**: P2

#### T-17: Server update called immediately on schedule
```typescript
test('should call updateTask store method on schedule', async () => {
  const updateTask = vi.fn()
  vi.spyOn(taskStore, 'updateTask').mockImplementation(updateTask)
  
  // Setup and trigger schedule
  await triggerSchedule('task-1', '2025-12-03T10:00:00')
  
  expect(updateTask).toHaveBeenCalled()
})
```
**Priority**: P0 | **Risk Coverage**: AC10, DATA-001

### Confirmation Dialog

#### T-18: Show confirmation for ≥60 minute change
```typescript
test('should show confirmation when time difference >= 60 minutes', () => {
  const { result } = renderHook(() => useScheduleConfirmation())
  
  act(() => {
    result.current.checkConfirmation(
      mockTask({ scheduledTime: '2025-12-03T09:00:00' }),
      '2025-12-03T11:00:00' // 2 hours later
    )
  })
  
  expect(result.current.needsConfirmation).toBe(true)
})
```
**Priority**: P0 | **Risk Coverage**: AC11, UX-002

#### T-19: Skip confirmation for <60 minute change
```typescript
test('should not show confirmation when time difference < 60 minutes', () => {
  const { result } = renderHook(() => useScheduleConfirmation())
  
  act(() => {
    result.current.checkConfirmation(
      mockTask({ scheduledTime: '2025-12-03T09:00:00' }),
      '2025-12-03T09:30:00' // 30 minutes later
    )
  })
  
  expect(result.current.needsConfirmation).toBe(false)
})
```
**Priority**: P1

---

## Integration Tests

### I-01: Drag task from list to time block
```typescript
test('dragging task from list to time block schedules it', async () => {
  render(<ScheduleView {...props} />)
  
  const task = screen.getByText('Test Task')
  const timeBlock = screen.getByTestId('time-block-10:00')
  
  // Simulate drag
  await userEvent.drag(task, { to: timeBlock })
  
  // Verify task appears in time block
  await waitFor(() => {
    expect(within(timeBlock).getByText('Test Task')).toBeInTheDocument()
  })
})
```
**Priority**: P0

### I-02: Drag task between time blocks
```typescript
test('dragging task between time blocks updates scheduledTime', async () => {
  const task = mockTask({ scheduledTime: '2025-12-03T09:00:00' })
  render(<ScheduleView tasks={[task]} {...props} />)
  
  const taskElement = screen.getByText(task.title)
  const targetBlock = screen.getByTestId('time-block-14:00')
  
  await userEvent.drag(taskElement, { to: targetBlock })
  
  await waitFor(() => {
    expect(mockUpdateTask).toHaveBeenCalledWith(
      task.id,
      expect.objectContaining({ scheduledTime: expect.stringContaining('14:00') })
    )
  })
})
```
**Priority**: P0

### I-03: Visual feedback during drag
```typescript
test('drop zone highlights when task is dragged over', async () => {
  render(<ScheduleView {...props} />)
  
  const task = screen.getByText('Test Task')
  const timeBlock = screen.getByTestId('time-block-10:00')
  
  // Start drag and hover
  fireEvent.dragStart(task)
  fireEvent.dragOver(timeBlock)
  
  // Verify highlight class
  expect(timeBlock).toHaveClass('ring-2', 'ring-primary')
})
```
**Priority**: P1

### I-04: Task time updates on drop
```typescript
test('task scheduledTime updates after drop', async () => {
  const updateTask = vi.fn()
  render(<ScheduleView onTaskUpdate={updateTask} {...props} />)
  
  // Perform drag and drop
  await performDragDrop('task-1', 'time-block-11:00')
  
  expect(updateTask).toHaveBeenCalledWith(
    'task-1',
    expect.objectContaining({
      scheduledTime: expect.stringMatching(/11:00/)
    })
  )
})
```
**Priority**: P0

### I-05: Tasks snap to time block boundaries
```typescript
test('dropped task aligns to time block start time', async () => {
  render(<ScheduleView {...props} />)
  
  // Drop in middle of 10:00-10:30 block
  await performDragDrop('task-1', 'time-block-10:00')
  
  // Should snap to block start (10:00), not arbitrary position
  expect(mockUpdateTask).toHaveBeenCalledWith(
    'task-1',
    expect.objectContaining({
      scheduledTime: expect.stringContaining('10:00')
    })
  )
})
```
**Priority**: P1

### I-06: Invalid drop rejected
```typescript
test('drop on disabled time block does not schedule task', async () => {
  render(<TimeBlockDropZone timeBlockId="10:00" disabled={true}>Content</TimeBlockDropZone>)
  
  // Attempt drop on disabled zone
  const zone = screen.getByTestId('time-block-10:00')
  
  expect(zone).toHaveClass('cursor-not-allowed')
  // Task should not be scheduled
})
```
**Priority**: P1

### I-07: Undo reverts last operation
```typescript
test('clicking undo button reverts last schedule change', async () => {
  render(<ScheduleView {...props} />)
  
  // Schedule task
  await performDragDrop('task-1', 'time-block-10:00')
  
  // Find and click undo in toast
  const undoButton = await screen.findByRole('button', { name: /undo/i })
  await userEvent.click(undoButton)
  
  // Verify revert
  await waitFor(() => {
    expect(mockUpdateTask).toHaveBeenLastCalledWith(
      'task-1',
      expect.objectContaining({ scheduledTime: undefined })
    )
  })
})
```
**Priority**: P0

### I-08: Server persistence on drop
```typescript
test('schedule change persists to server immediately', async () => {
  const serverUpdate = vi.fn()
  vi.spyOn(taskStore, 'updateTask').mockImplementation(serverUpdate)
  
  render(<ScheduleView {...props} />)
  
  await performDragDrop('task-1', 'time-block-10:00')
  
  expect(serverUpdate).toHaveBeenCalledTimes(1)
})
```
**Priority**: P0

### I-09: Confirmation dialog for large time change
```typescript
test('shows confirmation dialog when moving task >1 hour', async () => {
  const task = mockTask({ scheduledTime: '2025-12-03T09:00:00' })
  render(<ScheduleView tasks={[task]} {...props} />)
  
  // Move to 3 hours later
  await performDragDrop(task.id, 'time-block-12:00')
  
  // Dialog should appear
  expect(await screen.findByText('Confirm Schedule Change')).toBeInTheDocument()
  expect(screen.getByText(/3 hours later/i)).toBeInTheDocument()
})
```
**Priority**: P0

---

## E2E Tests

### E-01: Full schedule workflow
```typescript
test('user can schedule, view, and unschedule a task', async ({ page }) => {
  await page.goto('/')
  
  // Create task
  await page.click('[data-testid="add-task"]')
  await page.fill('[name="title"]', 'E2E Test Task')
  await page.click('[type="submit"]')
  
  // Drag to schedule
  const task = page.getByText('E2E Test Task')
  const timeBlock = page.getByTestId('time-block-10:00')
  await task.dragTo(timeBlock)
  
  // Verify scheduled
  await expect(page.getByTestId('time-block-10:00')).toContainText('E2E Test Task')
  
  // Drag back to unschedule
  const scheduledTask = page.getByTestId('time-block-10:00').getByText('E2E Test Task')
  const taskList = page.getByTestId('task-list')
  await scheduledTask.dragTo(taskList)
  
  // Verify unscheduled
  await expect(page.getByTestId('task-list')).toContainText('E2E Test Task')
})
```
**Priority**: P0

### E-02: Confirmation dialog flow
```typescript
test('confirmation dialog allows cancel and confirm', async ({ page }) => {
  // Setup: task at 9:00
  await setupTaskAt('09:00')
  
  // Drag to 2pm (5 hours later)
  await performDragDrop('task-1', '14:00')
  
  // Dialog appears
  await expect(page.getByText('Confirm Schedule Change')).toBeVisible()
  
  // Cancel
  await page.click('button:has-text("Cancel")')
  await expect(page.getByTestId('time-block-09:00')).toContainText('Test Task')
  
  // Try again and confirm
  await performDragDrop('task-1', '14:00')
  await page.click('button:has-text("Confirm")')
  await expect(page.getByTestId('time-block-14:00')).toContainText('Test Task')
})
```
**Priority**: P1

---

## Manual Tests

### M-01: iOS Safari Touch Drag
**Priority**: P0 | **Risk Coverage**: TECH-001, AC8

**Steps**:
1. Open app on iOS Safari (iPhone/iPad)
2. Long-press on a task (200ms)
3. Drag to a time block
4. Release

**Expected**:
- Drag initiates after long press
- No scroll interference
- Task schedules correctly
- Visual feedback visible during drag

---

### M-02: Android Chrome Touch Drag
**Priority**: P0 | **Risk Coverage**: TECH-001, AC8

**Steps**:
1. Open app on Android Chrome
2. Long-press on a task
3. Drag to a time block
4. Release

**Expected**:
- Same as M-01

---

### M-03: Keyboard Navigation Drag
**Priority**: P1 | **Risk Coverage**: ACCESS-001

**Steps**:
1. Tab to a task
2. Press Space/Enter to activate
3. Use arrow keys to move
4. Press Space/Enter to drop

**Expected**:
- Task can be moved via keyboard
- Screen reader announces drag state

---

## Test Summary

| Level | Total | P0 | P1 | P2 |
|-------|-------|----|----|-----|
| Unit | 19 | 7 | 9 | 3 |
| Integration | 9 | 5 | 4 | 0 |
| E2E | 2 | 1 | 1 | 0 |
| Manual | 3 | 2 | 1 | 0 |
| **Total** | **33** | **15** | **15** | **3** |

---

## Coverage Gaps

| AC | Gap | Recommendation |
|----|-----|----------------|
| AC6 | Resizing not implemented | Defer to future story |
| AC8 | No automated touch tests | Manual testing required |

---

## Test Implementation Status

⬜ Not Started - Tests designed but implementation deferred per MVP scope

**Recommendation**: Implement P0 tests before production release. P1/P2 tests can be added incrementally.
