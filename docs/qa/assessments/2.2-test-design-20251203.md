# Test Design: Story 2.2 - Time Tracking Analytics Widget

Date: 2025-12-03
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 28
- **Unit tests**: 16 (57%)
- **Integration tests**: 8 (29%)
- **E2E tests**: 4 (14%)
- **Priority distribution**: P0: 6, P1: 12, P2: 8, P3: 2

## Test Scenarios by Acceptance Criteria

### AC1: Time tracking widget on main dashboard

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.2-INT-001 | Integration | P1 | Widget renders in App.tsx layout | Component integration in dashboard |
| 2.2-E2E-001 | E2E | P1 | Widget visible on page load | User-facing critical path |

### AC2: Show total time tracked today

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.2-UNIT-001 | Unit | P0 | calculateDailyStats returns correct totalTrackedMs | Core calculation logic |
| 2.2-UNIT-002 | Unit | P1 | calculateDailyStats handles empty task array | Edge case handling |
| 2.2-UNIT-003 | Unit | P1 | calculateDailyStats filters only today's tasks | Date filtering logic |
| 2.2-UNIT-004 | Unit | P2 | formatDuration displays HH:MM correctly | Display formatting |

### AC3: Show estimated vs actual time variance

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.2-UNIT-005 | Unit | P0 | Variance calculated as (actual - estimated) | Core business logic |
| 2.2-UNIT-006 | Unit | P0 | Variance color coding: green ≤0, yellow ≤20%, red >20% | Visual accuracy rules |
| 2.2-UNIT-007 | Unit | P1 | Handles zero estimated duration (no division by zero) | Critical edge case |
| 2.2-INT-002 | Integration | P1 | Variance display updates when task completes | State integration |

### AC4: Breakdown by project or category

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.2-UNIT-008 | Unit | P1 | calculateProjectBreakdown groups tasks by project | Grouping logic |
| 2.2-UNIT-009 | Unit | P1 | "No Project" category for unassigned tasks | Edge case |
| 2.2-UNIT-010 | Unit | P2 | Percentage calculation sums to 100% | Mathematical correctness |
| 2.2-UNIT-011 | Unit | P2 | Results sorted by time tracked descending | Sorting logic |

### AC5: Time estimation accuracy percentage

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.2-UNIT-012 | Unit | P0 | Accuracy = 100 - abs(variance/estimated * 100) | Core formula |
| 2.2-UNIT-013 | Unit | P1 | Accuracy capped at 0% (not negative) | Boundary validation |
| 2.2-UNIT-014 | Unit | P1 | Accuracy shows "N/A" when no estimates exist | Edge case display |

### AC6: Weekly time tracking history chart

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.2-UNIT-015 | Unit | P1 | getWeeklyHistory returns 7 days of data | Data aggregation |
| 2.2-INT-003 | Integration | P1 | Chart renders with correct bar heights | Visual integration |
| 2.2-INT-004 | Integration | P2 | Chart responsive to container width | Layout behavior |
| 2.2-E2E-002 | E2E | P2 | Tooltip shows exact values on hover | User interaction |

### AC7: Widget is collapsible

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.2-INT-005 | Integration | P1 | Toggle button expands/collapses widget | UI interaction |
| 2.2-INT-006 | Integration | P2 | Collapse state persists to localStorage | State persistence |
| 2.2-UNIT-016 | Unit | P2 | Widget restores collapse state on mount | Hook initialization |

### AC8: Real-time updates as timers run

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.2-INT-007 | Integration | P0 | Widget updates when timerStore.activeTaskId changes | Critical real-time sync |
| 2.2-E2E-003 | E2E | P1 | "Today's Time" increments during active timer | User-visible real-time behavior |

### AC9: Click through to detailed history

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.2-INT-008 | Integration | P2 | "View Details" opens modal/panel | Navigation interaction |
| 2.2-E2E-004 | E2E | P3 | Full history view shows task list with durations | End-to-end flow |

### AC10: Cache calculations to prevent performance issues

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.2-UNIT-017* | Unit | P1 | useMemo returns cached value for same inputs | Memoization correctness |
| 2.2-PERF-001 | Performance | P1 | Widget re-renders < 2 times per timer tick | Performance validation |

*Note: UNIT-017 tests memoization, counted in totals but numbered out of sequence.

## Risk Coverage Mapping

| Risk ID | Test IDs | Coverage |
|---------|----------|----------|
| PERF-001 (High) | 2.2-PERF-001, 2.2-INT-007 | Direct mitigation tests |
| PERF-002 | 2.2-UNIT-017, 2.2-PERF-001 | Caching validation |
| DATA-001 | 2.2-UNIT-005, 2.2-UNIT-007, 2.2-UNIT-012, 2.2-UNIT-013, 2.2-UNIT-014 | Edge case coverage |
| TECH-002 | 2.2-INT-007, 2.2-E2E-003 | State sync validation |

## Recommended Execution Order

### Phase 1: P0 Critical (Fail Fast)
1. 2.2-UNIT-001: Daily stats calculation
2. 2.2-UNIT-005: Variance calculation
3. 2.2-UNIT-006: Variance color coding
4. 2.2-UNIT-012: Accuracy formula
5. 2.2-INT-007: Real-time timerStore sync
6. 2.2-PERF-001: Re-render performance

### Phase 2: P1 High Priority
1. All remaining UNIT tests (edge cases)
2. 2.2-INT-001, 2.2-INT-002, 2.2-INT-003: Component integrations
3. 2.2-E2E-001, 2.2-E2E-003: Critical user journeys

### Phase 3: P2 Medium Priority
1. 2.2-INT-004, 2.2-INT-005, 2.2-INT-006, 2.2-INT-008: Secondary integrations
2. 2.2-UNIT-004, 2.2-UNIT-010, 2.2-UNIT-011, 2.2-UNIT-016: Format/sort logic
3. 2.2-E2E-002: Chart interaction

### Phase 4: P3 (If Time Permits)
1. 2.2-E2E-004: Detailed history view

## Test Data Requirements

### Mock Task Data
```typescript
const mockTasks: TaskType[] = [
  // Task with time tracking completed
  {
    id: '1',
    title: 'Task A',
    date: new Date(), // today
    estimatedDuration: 60, // 1 hour
    actualDuration: 45, // 45 min (on track)
    project: 'Project Alpha',
    timeTracking: { status: 'completed', accumulatedMs: 2700000, history: [] }
  },
  // Task over estimate
  {
    id: '2',
    title: 'Task B',
    date: new Date(),
    estimatedDuration: 30,
    actualDuration: 50, // over by 67%
    project: 'Project Alpha',
    timeTracking: { status: 'completed', accumulatedMs: 3000000, history: [] }
  },
  // Task with no estimate
  {
    id: '3',
    title: 'Task C',
    date: new Date(),
    estimatedDuration: undefined,
    actualDuration: 20,
    project: undefined, // No project
    timeTracking: { status: 'completed', accumulatedMs: 1200000, history: [] }
  },
  // Yesterday's task (should be excluded from today)
  {
    id: '4',
    title: 'Task D',
    date: new Date(Date.now() - 86400000), // yesterday
    estimatedDuration: 60,
    actualDuration: 60,
    timeTracking: { status: 'completed', accumulatedMs: 3600000, history: [] }
  }
];
```

### Expected Calculations
- **Total tracked today**: 45 + 50 + 20 = 115 minutes
- **Total estimated today**: 60 + 30 = 90 minutes (tasks with estimates)
- **Variance**: +25 minutes (over)
- **Accuracy**: 100 - |25/90 * 100| = 72.2%
- **Project breakdown**: Alpha: 95min (83%), No Project: 20min (17%)

## Test File Locations

Per project standards (`__tests__` directories):

```
src/hooks/__tests__/useTimeAnalytics.test.ts      # Unit tests (UNIT-001 to UNIT-017)
src/components/__tests__/TimeAnalyticsWidget.test.tsx  # Integration tests
e2e/time-analytics.spec.ts                        # E2E tests (Playwright)
```

## Testing Tools & Patterns

- **Unit**: Vitest + @testing-library/react-hooks
- **Integration**: Vitest + React Testing Library
- **E2E**: Playwright
- **Performance**: React DevTools Profiler, console.time/timeEnd

## Quality Checklist Verification

- [x] Every AC has test coverage (28 scenarios across 10 ACs)
- [x] Test levels are appropriate (unit for logic, integration for components)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (calculations P0, UI polish P2)
- [x] Test IDs follow naming convention (2.2-LEVEL-SEQ)
- [x] Scenarios are atomic and independent

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 28
  by_level:
    unit: 16
    integration: 8
    e2e: 4
  by_priority:
    p0: 6
    p1: 12
    p2: 8
    p3: 2
  coverage_gaps: []
```

---

**Test design matrix**: docs/qa/assessments/2.2-test-design-20251203.md
**P0 tests identified**: 6

